<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f5dc 0%, #faf0e6 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #475569 0%, #64748b 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        /* Tab Navigation */
        .tab-navigation {
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            overflow-x: auto;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 15px 30px;
            cursor: pointer;
            font-size: 1em;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-button:hover {
            background: #e9ecef;
            color: #2c3e50;
        }

        .tab-button.active {
            color: #2c3e50;
            border-bottom-color: #3498db;
            background: white;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 40px;
            padding: 30px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        /* Remove parallel sections styles since we don't need them anymore */
        .upload-section {
            margin-bottom: 40px;
        }

        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #2980b9;
            background: #f8f9fa;
        }

        .upload-area.dragover {
            border-color: #27ae60;
            background: #e8f5e8;
        }

        .search-area {
            border: 3px solid #28a745;
            border-radius: 10px;
            padding: 40px;
            background: white;
            transition: all 0.3s ease;
            text-align: center;
        }

        .search-area:hover {
            border-color: #218838;
            background: #f8f9fa;
        }

        input[type="file"] {
            display: none;
        }

        .search-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1.1em;
            margin: 15px 0;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .upload-icon, .search-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .upload-icon {
            color: #3498db;
        }

        .search-icon {
            color: #28a745;
        }

        .btn {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-search {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        }

        .btn-search:hover {
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .comparison-options {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* Changed to three columns */
            gap: 20px;
            margin: 20px 0;
        }

        .option-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 120px; /* Ensure consistent height */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .option-card:hover {
            border-color: #3498db;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .option-card.selected {
            border-color: #3498db;
            background: #e3f2fd;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .option-card h3 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .option-card p {
            color: #6c757d;
            font-size: 0.9em;
            line-height: 1.4;
            margin: 0;
        }

        /* Enhanced analysis results styling */
        .yoy-analysis {
            background: #F7FAFC;
            border-left: 4px solid #64748B;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .yoy-analysis h5 {
            margin-bottom: 10px;
            color: #F7FAFC;
            font-size: 1em;
        }

        .pricing-issues {
            background: #F1F5F9;
            border-left: 4px solid #475569;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .pricing-issues h5 {
            margin-bottom: 10px;
            color: #475569;
            font-size: 1em;
        }

        .incomplete-pricing {
            background: #F1F5F9;
            border-left: 4px solid #475569;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .incomplete-pricing h5 {
            margin-bottom: 10px;
            color: #475569;
            font-size: 1em;
        }

        .incomplete-pricing ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .incomplete-pricing li {
            color: #475569;
            margin-bottom: 5px;
        }

        .pricing-concerns {
            background: #F1F5F9;
            border-left: 4px solid #475569;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .pricing-concerns h5 {
            margin-bottom: 10px;
            color: #475569;
            font-size: 1em;
        }

        .analysis-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            text-align: center;
            white-space: nowrap;
        }

        .analysis-badge.high-risk {
            background: #f44336;
        }

        .analysis-badge.medium-risk {
            background: #ff9800;
            color: #212529;
        }

        .analysis-badge.low-risk {
            background: #4caf50;
        }

        .analysis-badge.found {
            background: #4caf50;
        }

        .analysis-badge.not-found {
            background: #f44336;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        .analysis-item {
            margin-bottom: 8px;
        }

        .analysis-item strong {
            color: #2c3e50;
        }

        @media (max-width: 768px) {
            .comparison-options {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .comparison-options {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .option-card:nth-child(3) {
                grid-column: auto;
                max-width: 100%;
                margin: 0;
            }
            
            .analysis-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Enhanced contract summary styling */
        .contract-summary {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .contract-summary h4 {
            margin-bottom: 15px;
            color: #1976d2;
            font-size: 1.2em;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        .summary-item {
            margin-bottom: 8px;
        }

        .summary-item strong {
            color: #2c3e50;
            display: inline-block;
            min-width: 120px;
        }

        /* Status indicators */
        .status-indicator {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-align: center;
            white-space: nowrap;
        }

        .status-indicator.yes {
            background: #f44336;
            color: white;
        }

        .status-indicator.no {
            background: #4caf50;
            color: white;
        }

        /* Detailed analysis section */
        .detailed-analysis {
            background: white;
            border-left: 4px solid #6c757d;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .detailed-analysis h4 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .analysis-content {
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 1em;
            margin-top: 15px;
        }

        /* Animation for option cards */
        .option-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .option-card:hover {
            transform: translateY(-3px);
        }

        .option-card.selected {
            transform: translateY(-2px);
        }

        /* Enhanced typography */
        .analysis-section h5 {
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .analysis-section p {
            line-height: 1.5;
            color: #5a6c7d;
            margin-bottom: 10px;
        }

        .analysis-section ul {
            margin: 10px 0 10px 20px;
        }

        .analysis-section li {
            margin-bottom: 5px;
            line-height: 1.4;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-top: 20px;
            border-left: 5px solid #3498db;
        }

        .file-info {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            display: none;
        }

        .config-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .success {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        /* Enhanced table styles for better visibility */
        .contracts-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
            margin-top: 15px;
        }

        .contracts-table th,
        .contracts-table td {
            border: 1px solid #dee2e6;
            padding: 12px 8px;
            text-align: left;
            vertical-align: top;
        }

        .contracts-table th {
            background: #374151; /* 统一的深灰 */
            color: white;
            font-weight: 600; /* 稍微粗一点但不会太重 */
            position: sticky;
            top: 0;
        }

        .contracts-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .contracts-table tbody tr:hover {
            background: #e3f2fd;
        }

        /* Column specific widths */
        .col-contract-id { width: 120px; }
        .col-client { width: 200px; }
        .col-contract-name { width: 250px; }
        .col-vendor { width: 180px; }
        .col-product { 
            width: 300px; 
            max-width: 300px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .col-period { width: 160px; }
        .col-spend { width: 120px; }
        .col-file { width: 120px; }

        .product-cell {
            max-height: 80px;
            overflow-y: auto;
            font-size: 0.85em;
            line-height: 1.3;
        }

        .search-filters {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 0.9em;
            position: relative;
        }

        /* Client multi-select styles */
        .multi-select-container {
            position: relative;
        }

        .selected-client-tag {
            display: inline-flex;
            align-items: center;
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 16px;
            padding: 4px 8px;
            font-size: 0.8em;
            margin: 2px;
            max-width: 200px;
        }

        .selected-client-tag .client-name {
            margin-right: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .selected-client-tag .remove-client {
            cursor: pointer;
            color: #2196f3;
            font-weight: bold;
            font-size: 1.1em;
            line-height: 1;
            padding: 0 2px;
            border-radius: 50%;
            background: transparent;
            border: none;
        }

        .selected-client-tag .remove-client:hover {
            background: #2196f3;
            color: white;
        }

        #selectedClients:empty {
            display: none;
        }

        #clientSuggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 2px;
        }

        .suggestion-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }

        .suggestion-item:hover,
        .suggestion-item.suggestion-active {
            background-color: #e3f2fd !important;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .search-results-section {
            background: #f9fafb;
            border-left: 4px solid #6b7280;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        /* GL Table Styles */
        .gl-section {
            background: #fafaf9;
            border-left: 4px solid #78716c;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .gl-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
            margin-top: 15px;
        }

        .gl-table th,
        .gl-table td {
            border: 1px solid #dee2e6;
            padding: 10px 8px;
            text-align: left;
            vertical-align: top;
        }

        .gl-table th {
            background: #374151; /* 统一的深灰 */
            color: white;
            font-weight: 600; /* 稍微粗一点但不会太重 */
        }

        .gl-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .gl-table tbody tr:hover {
            background: #e6f3ff;
        }

        /* GL column widths */
        .col-gl-count { width: 80px; }
        .col-gl-clname { width: 200px; }
        .col-gl-vendor { width: 180px; }
        .col-gl-amount { width: 120px; }
        .col-gl-parent { width: 100px; }
        .col-gl-year { width: 80px; }

        /* Jira Tickets Styles */
        .jira-section {
            background: #f1f5f9;
            border-left: 4px solid #475569;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .tickets-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
            margin-top: 15px;
        }

        .tickets-table th,
        .tickets-table td {
            border: 1px solid #dee2e6;
            padding: 10px 8px;
            text-align: left;
            vertical-align: top;
        }

        .tickets-table th {
            background: #374151;
            color: white;
            font-weight: 600;
        }

        .tickets-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .tickets-table tbody tr:hover {
            background: #fff3e0;
        }

        /* Status and Priority badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            text-align: center;
            white-space: nowrap;
        }

        .status-badge.todo { background: #1F3A8A; }
        .status-badge.work-in-progress { background: #3B81F6; }
        .status-badge.done { background: #FBBE24; color: #212529; }
        .status-badge.future-project { background: #3B81F6; }
        .status-badge.infosec-review { background: #3B81F6; }
        .status-badge.legal-review { background: #3B81F6; }
        .status-badge.negotiations { background: #3B81F6; }
        .status-badge.database { background: #FBBE24; color: #212529; }
        .status-badge.collection { background: #1F3A8A; }
        .status-badge.procurement { background: #3B81F6; }
        .status-badge.signature { background: #FBBE24; color: #212529; }
        .status-badge.stakeholder { background: #3B81F6; }
        .status-badge.vendor { background: #3B81F6; }
        .status-badge.open { background: #1F3A8A; }

        .priority-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            text-align: center;
        }

        .priority-badge.high { background: #dc3545; }
        .priority-badge.medium { background: #ffc107; color: #212529; }
        .priority-badge.low { background: #28a745; }

        /* Combined Results Layout */
        .combined-results {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .results-summary {
            background: #f8fafc;
            border-left: 4px solid #64748b;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .btn-create-ticket {
            background: #64748b;
            color: white;
            }
            .btn-create-ticket:hover {
            box-shadow: 0 5px 15px rgba(111, 66, 193, 0.4);
        }

        @media (max-width: 1204px) {
            .search-filters {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .search-filters {
                grid-template-columns: 1fr;
            }
            
            .contracts-table, .tickets-table {
                font-size: 0.8em;
            }
            
            .col-product {
                width: 200px;
                max-width: 200px;
            }
        }

        .system-status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            align-items: flex-start; /* 改为flex-start以便更好的对齐 */
        }

        .status-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            min-height: 120px; /* 确保统一高度 */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .status-item h4 {
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .status-item p {
            margin-bottom: 12px;
            color: #6c757d;
            font-size: 0.9em;
            flex-grow: 1;
        }

        .status-item .btn {
            margin: 8px 0 0 0;
            width: 100%;
        }

        .status-item .status-indicator {
            margin-top: 8px;
        }

        /* 响应式设计 */
        @media (max-width: 1024px) {
            .system-status-grid {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .status-item:nth-child(3) {
                grid-column: 1 / -1;
                max-width: 50%;
                margin: 0 auto;
            }
        }

        @media (max-width: 768px) {
            .system-status-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .status-item:nth-child(3) {
                grid-column: auto;
                max-width: 100%;
                margin: 0;
            }
            
            .status-item {
                min-height: 100px;
            }
        }

        .col-gl-amount { 
            width: 120px; 
            text-align: left; 
        }
        .col-spend { 
            width: 120px; 
            text-align: left;
        }

        .col-gl-amount, .col-spend { 
            text-align: right !important;
        }

        .button-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .selected-vendor-tag {
            display: inline-flex;
            align-items: center;
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 16px;
            padding: 4px 8px;
            font-size: 0.8em;
            margin: 2px;
            max-width: 200px;
        }

        .selected-vendor-tag .vendor-name {
            margin-right: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .selected-vendor-tag .remove-vendor {
            cursor: pointer;
            color: #2196f3;
            font-weight: bold;
            font-size: 1.1em;
            line-height: 1;
            padding: 0 2px;
            border-radius: 50%;
            background: transparent;
            border: none;
        }

        .selected-vendor-tag .remove-vendor:hover {
            background: #2196f3;
            color: white;
        }

        .vendor-suggestion-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }

        .vendor-suggestion-item:hover {
            background-color: #e3f2fd !important;
        }

        .vendor-suggestion-item:last-child {
            border-bottom: none;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 0.75em; /* 从 0.8em 改为 0.75em */
            background: white; /* 添加 */
            border-radius: 4px; /* 添加 */
            overflow: hidden; /* 添加 */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* 添加 */
}

        .data-table th, .data-table td {
            border: 1px solid #e9ecef;
            padding: 6px 8px;
            text-align: left;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057; /* 添加 */
            font-size: 0.7em; /* 添加 */
            text-transform: uppercase; /* 添加 */
            letter-spacing: 0.5px; /* 添加 */
        }

        .data-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tbody tr:hover {
            background: #e3f2fd;
        }

        .suggestion-chip {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 12px; /* 从 15px 改为 12px */
            padding: 4px 8px; /* 从 6px 12px 改为 4px 8px */
            font-size: 0.75em; /* 从 0.8em 改为 0.75em */
            cursor: pointer;
            transition: all 0.2s; /* 从 0.3s 改为 0.2s */
            white-space: nowrap; /* 添加 */
        }

        .suggestion-chip:hover {
            background: #6b7280;
            color: white;
            transform: translateY(-1px); /* 添加 */
        }

        /* 修改现有的 message-content pre 样式 */
        .message-content pre {
            background: #f8f9fa !important;
            border: 1px solid #e9ecef; /* 添加 */
            border-radius: 4px;
            margin: 8px 0;
            max-width: 100%;
            overflow-x: auto;
        }

        .message-content code {
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            line-height: 1.4;
        }

        .message-content code {
            background: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-content strong {
            font-weight: 600;
        }

        .message-content em {
            font-style: italic;
        }

        .chatbot-input-area {
            background: white;
            border-radius: 0 0 13px 13px;
            padding: 15px 20px;
            border-top: 1px solid #e9ecef;
        }

        .chatbot-file-area {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chatbot-file-area:hover {
            border-color: #6b7280;
            background: #f1f3f4;
        }

        .chatbot-file-area.dragover {
            border-color: #6b7280;
            background: #e3f2fd;
        }

        .file-upload-icon {
            font-size: 1.2em;
            color: #6c757d;
        }

        .file-upload-text {
            flex: 1;
            color: #6c757d;
            font-size: 0.9em;
        }


        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .file-preview-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 5px;
        }

        .file-preview-name {
            font-weight: 600;
            color: #1976d2;
            font-size: 0.9em;
            flex: 1;
        }

        .file-preview-size {
            color: #6c757d;
            font-size: 0.8em;
            margin-right: 10px;
        }

        .remove-file-btn {
            background: #1F3A8A;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .remove-file-btn:hover {
            background: #1F3A8A;
            transform: scale(1.1);
        }

        .file-type-icon {
            margin-right: 8px;
            font-size: 1.1em;
        }

        .chatbot-send.with-file {
            background: #2196f3;
        }

        .chatbot-send.with-file:hover {
            background: #1976d2;
        }

        /* File message styling */
        .message.file-message .message-content {
            border-left: 3px solid #2196f3;
            background: #f3f4f6;
            position: relative;
        }

        .file-message-header {
            background: #e3f2fd;
            margin: -10px -15px 10px -15px;
            padding: 8px 15px;
            border-radius: 8px 8px 0 0;
            font-size: 0.85em;
            color: #1976d2;
            font-weight: 600;
        }

        .processing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: #ff9800;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .processing-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid #FFF2CD;
            border-top: 2px solid #FFF2CD;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Supported file types tooltip */
        .file-types-tooltip {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: #2c3e50;
            color: white;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 0.8em;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .chatbot-file-area:hover .file-types-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .file-types-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 20px;
            border: 5px solid transparent;
            border-top-color: #2c3e50;
        }
        
        .batch-search-controls {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                padding: 0 15px;
            }
            to {
                opacity: 1;
                max-height: 200px;
                padding: 15px;
            }
        }

        .batch-search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .batch-search-title {
            color: #2c3e50;
            font-weight: 600;
            font-size: 1.1em;
        }

        .selected-count {
            background: #3B81F6;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .search-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .batch-search-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .batch-search-input:focus {
            outline: none;
            border-color: #3B81F6;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .batch-search-btn {
            background: linear-gradient(135deg, #3B81F6 0%, #3B81F6 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .batch-search-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .batch-search-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .batch-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 0.9em;
        }

        .clear-selection-btn {
            background: #1F3A8A;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .clear-selection-btn:hover {
            background: #1F3A8A;
        }

        /* Checkbox styles for contract table */
        .contract-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #3498db;
        }

        .select-all-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #3B81F6;
        }

        /* Search results styles */
        .batch-search-results {
            background: white;
            border-left: 4px solid #3B81F6;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .search-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .search-results-title {
            color: #2c3e50;
            font-size: 1.2em;
            font-weight: 600;
        }

        .search-stats {
            background: #e3f2fd;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            color: #3B81F6;
            font-weight: 500;
        }

        .contract-result-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .contract-result-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-color: #3B81F6;
        }

        .contract-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .contract-result-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1em;
        }

        .match-count-badge {
            background: #3B81F6;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .contract-result-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #6c757d;
        }

        .matches-container {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .match-item {
            background: white;
            border: 1px solid #616977;
            border-radius: 4px;
            padding: 8px;
            margin: 5px 0;
            font-size: 0.85em;
        }

        .match-field {
            font-weight: 600;
            color: #6c757d;
            font-size: 0.8em;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .match-context {
            color: #5d4037;
            line-height: 1.4;
        }

        .match-context strong {
            background: black;
            padding: 1px 2px;
            border-radius: 2px;
            color: #333;
        }

        .no-matches-item {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        /* Loading state for batch search */
        .batch-search-loading {
            display: none;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            margin: 15px 0;
        }

        .batch-search-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .search-input-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .batch-search-input {
                margin-bottom: 10px;
            }
            
            .contract-result-details {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .search-results-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .user-avatar::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #4CAF50;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* 用户信息容器 */
        .user-info-container {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
            font-size: 0.9em;
            z-index: 1000;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .user-name {
            font-weight: 600;
            font-size: 1em;
            margin-bottom: 2px;
        }

        .user-role {
            opacity: 0.8;
            font-size: 0.8em;
            text-transform: capitalize;
        }

        /* 用户菜单样式 */
        .user-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            min-width: 200px;
            display: none;
            z-index: 1001;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .user-menu-header {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            color: #333;
        }

        .user-menu-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-menu-email {
            font-size: 0.85em;
            color: #666;
        }

        .user-menu-item {
            width: 100%;
            background: none;
            border: none;
            padding: 12px 16px;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s;
            color: #333;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-menu-item:hover {
            background: #f5f5f5;
        }

        .user-menu-item.danger {
            color: #dc3545;
        }

        .user-menu-item.danger:hover {
            background: #fef2f2;
        }

        .user-menu-divider {
            border-top: 1px solid #eee;
            margin: 8px 0;
        }

        /* 在线状态指示器 */
        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #4CAF50;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .user-info-container {
                top: 15px;
                right: 20px;
                gap: 10px;
            }
            
            .user-avatar {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }
            
            .user-details {
                display: none;
            }
            
            .user-menu {
                right: -20px; 
                min-width: 180px;
            }
        }

        /* Contract action buttons for batch search results */
        .contract-preview-btn {
            background: #1F3A8A !important;
            color: white !important;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s ease;
            flex: 1;
            margin-right: 4px;
        }

        .contract-preview-btn:hover {
            background: #1d4ed8 !important;
            transform: translateY(-1px);
        }

        .contract-download-btn {
            background: #3C80F5 !important;
            color: white !important;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s ease;
            flex: 1;
            margin-left: 4px;
        }

        .contract-download-btn:hover {
            background: #4b5563 !important;
            transform: translateY(-1px);
        }

        /* Enhanced matches container */
        .matches-container {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid #e9ecef;
        }

        .match-context strong {
            background: #FBBE24;
            padding: 1px 2px;
            border-radius: 2px;
            color: #333;
        }

        /* Jira ticket ID links */
        .jira-ticket-link {
            color: black;
            text-decoration: none;
            font-weight: 600;
            border-bottom: 1px solid transparent;
            transition: all 0.2s ease;
            padding: 2px 0;
        }

        .jira-ticket-link:hover {
            color: #FBBE24;
            border-bottom-color: black;
            text-decoration: none;
        }

        .jira-ticket-link:visited {
            color: black;
        }
    </style>
</head>
<body>
    <div class="container">

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('ai-assistant')">
                Aria - AI Assistant
            </button>
            <button class="tab-button" onclick="switchTab('contract-analysis')">
                Contract Analysis
            </button>
            <button class="tab-button" onclick="switchTab('search-jira')">
                Search Vendors
            </button>
            <button class="tab-button" onclick="switchTab('contract-search')">
                Search Contracts
            </button>
        </div>

        <div id="ai-assistant" class="tab-content active">
            <iframe src="chatbot.html" 
                    style="width: 100%; height: 80vh; border: none; border-radius: 10px;">
            </iframe>
        </div>

        <!-- Tab 2: Contract Analysis -->
        <div id="contract-analysis" class="tab-content">

            <!-- Upload Contract Section -->
            <div class="section">
                <h2>Upload Contract for Analysis</h2>
                <div class="upload-area" onclick="document.getElementById('contractFile').click()">
                    <div class="upload-icon">📎</div>
                    <h3>Click to upload or drag and drop</h3>
                    <p>Supported formats: PDF, DOCX, TXT</p>
                    <input type="file" id="contractFile" accept=".pdf,.docx,.txt" onchange="handleFileUpload(this)">
                </div>
                <div class="file-info" id="fileInfo"></div>
                <p style="margin-top: 15px; color: #6c757d; font-style: italic;">
                    For searching existing contracts and Jira tickets, use the "Search Vendors/Contracts" tab above.
                </p>
            </div>

            <!-- Comparison Options (only show when file is uploaded) -->
            <div class="section" id="comparisonSection" style="display: none;">
                <h2>Comparison Type</h2>
                <div class="comparison-options" style="grid-template-columns: 1fr 1fr;">
                    <div class="option-card" onclick="selectOption('database')">
                        <h3>Database Comparison</h3>
                        <p>Compare with contracts stored in MySQL database</p>
                    </div>
                    <div class="option-card" onclick="selectOption('standard')">
                        <h3>Standard Template</h3>
                        <p>Still in the planning stage</p>
                    </div>
                </div>
                
                <!-- Standard Template Upload -->
                <div id="standardTemplateSection" style="display: none; margin-top: 20px;">
                    <div class="upload-area" onclick="document.getElementById('standardFile').click()">
                        <div class="upload-icon">📋</div>
                        <h3>Upload Standard Contract Template</h3>
                        <input type="file" id="standardFile" accept=".pdf,.docx,.txt" onchange="handleStandardUpload(this)">
                    </div>
                    <div class="file-info" id="standardFileInfo"></div>
                </div>
            </div>

            <!-- Analysis Section -->
            <div class="section">
                <h2>Analysis</h2>
                <button class="btn" id="analyzeBtn" onclick="analyzeContract()" disabled>
                    Start Analysis
                </button>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p id="loadingText">Analyzing contract with AI...</p>
                </div>

                <div class="error" id="errorMsg"></div>
                
                <div id="results"></div>
            </div>
        </div>

        <!-- Tab 3: Search Contracts & Jira Tickets -->
        <div id="search-jira" class="tab-content">
            <div class="section">
                <h2>Advanced Search - Contracts & Jira Tickets & GLs</h2>
                <p>Search for contracts, GLs and related Jira tickets by vendor, client, or keywords</p>
                
                <!-- Search Type Options -->
                <div style="margin: 20px 0;">
                    <h4>Search Type</h4>
                    <div style="display: flex; gap: 15px; margin: 10px 0; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" name="searchType" value="contracts" checked style="margin-right: 8px;">
                            <span>Contracts</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" name="searchType" value="jira" checked style="margin-right: 8px;">
                            <span>Jira Tickets</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" name="searchType" value="gl" checked style="margin-right: 8px;">
                            <span>General Ledger</span>
                        </label>
                    </div>
                </div>
                
                <!-- Search Input -->
                <div style="margin: 20px 0;">
                    <div class="multi-select-container">
                        <input type="text" class="search-input" id="mainSearchInput" 
                            placeholder="Type vendor name to add..." 
                            onkeypress="handleMainSearchKeyPress(event)"
                            oninput="showVendorSuggestions(this.value)">
                        <div id="selectedVendors" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 5px;"></div>
                        <div id="vendorSuggestions" style="display: none; position: absolute; background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; z-index: 1000; width: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 2px;"></div>
                    </div>
                </div>
                <!-- Advanced Search Filters -->
                <div id="mainSearchFilters">
                    <h4>Advanced Filters</h4>
                    <div class="search-filters">
                        <div class="filter-group">
                            <label for="mainFilterStatus">Contract Status</label>
                            <select id="mainFilterStatus">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="expired">Expired</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="mainFilterTicketStatus">Ticket Status</label>
                            <select id="mainFilterTicketStatus">
                                <option value="">All Ticket Status</option>
                                <option value="Added to Database">Added to Database</option>
                                <option value="Data Collection">Data Collection</option>
                                <option value="Done">Done</option>
                                <option value="Future Project">Future Project</option>
                                <option value="Open">Open</option>
                                <option value="Out for Signature">Out for Signature</option>
                                <option value="In Review">In Review</option>
                                <option value="InfoSec Review">InfoSec Review</option>
                                <option value="To Do">To Do</option>
                                <option value="W/ Vendor">W/ Vendor</option>
                                <option value="W/ Stakeholder">W/ Stakeholder</option>
                                <option value="W/ Procurement">W/ Procurement</option>
                                <option value="W/ Vendor">W/ Vendor</option>
                                <option value="W/ Stakeholder">W/ Stakeholder</option>
                                <option value="Work In progress">Work In Progress</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="mainFilterType">Contract Type</label>
                            <select id="mainFilterType">
                                <option value="">All Types</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="contractStartDateRange">Contract Start Date Range</label>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <input type="date" id="contractStartDateFrom" placeholder="From" 
                                       style="flex: 1; padding: 8px; border: 2px solid #e9ecef; border-radius: 5px; font-size: 0.9em;">
                                <span style="color: #6c757d; font-size: 0.9em;">to</span>
                                <input type="date" id="contractStartDateTo" placeholder="To" 
                                       style="flex: 1; padding: 8px; border: 2px solid #e9ecef; border-radius: 5px; font-size: 0.9em;">
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="contractEndDateRange">Contract End Date Range</label>
                            <div style="display: flex; gap: 5px; align-items: center;">
                                <input type="date" id="contractEndDateFrom" placeholder="From" 
                                       style="flex: 1; padding: 8px; border: 2px solid #e9ecef; border-radius: 5px; font-size: 0.9em;">
                                <span style="color: #6c757d; font-size: 0.9em;">to</span>
                                <input type="date" id="contractEndDateTo" placeholder="To" 
                                       style="flex: 1; padding: 8px; border: 2px solid #e9ecef; border-radius: 5px; font-size: 0.9em;">
                            </div>
                        </div>
                    </div>
                    <div class="button-row">
                        <button class="btn btn-search" onclick="searchContractsAndJira()">
                            Search
                        </button>
                        <button class="btn" onclick="clearMainFilters()">Clear Filters</button>
                        <button class="btn btn-create-ticket" onclick="openCreateTicketModal()">
                            Create Jira Ticket
                        </button>
                    </div>
                </div>

                <div class="loading" id="mainLoading">
                    <div class="spinner"></div>
                    <p id="mainLoadingText">Searching Contracts and Jira tickets...</p>
                </div>

                <div class="error" id="mainErrorMsg"></div>
                
                <div id="mainResults"></div>
            </div>
        </div>
            <!-- Create Jira Ticket Modal -->
            <div id="createTicketModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px; color: #536177;">Create Jira Ticket</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label for="ticketProject" style="display: block; font-weight: bold; margin-bottom: 5px;">Project:</label>
                        <select id="ticketProject" style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 5px;">
                            <option value="REQUEST">CCM Procurement & Tech Support (REQUEST)</option>
                            <option value="AP">Ankura Procurement (AP)</option>
                            <option value="CCP">Crash Champions Procurement (CCP)</option>
                            <option value="FBT">Frost Brown Procurement (FBT)</option>
                            <option value="OGLE">Ogletree Procurement (OGLE)</option>
                            <option value="PROSKAUER">Proskauer Procurement (PROSKAUER)</option>
                            <option value="RP">Ropes Procurement (RP)</option>
                        </select>
                    </div>
    
                    <div style="margin-bottom: 15px;">
                        <label for="ticketSummary" style="display: block; font-weight: bold; margin-bottom: 5px;">Summary:</label>
                        <input type="text" id="ticketSummary" placeholder="Brief description of the issue..." style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 5px;">
                    </div>
    
                    <div style="margin-bottom: 15px;">
                        <label for="ticketDescription" style="display: block; font-weight: bold; margin-bottom: 5px;">Description:</label>
                        <textarea id="ticketDescription" rows="4" placeholder="Detailed description of the issue or request..." style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 5px; resize: vertical;"></textarea>
                    </div>
    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label for="ticketPriority" style="display: block; font-weight: bold; margin-bottom: 5px;">Priority:</label>
                            <select id="ticketPriority" style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 5px;">
                                <option value="Highest">Highest</option>
                                <option value="High">High</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="Low">Low</option>
                                <option value="Lowest">Lowest</option>
                            </select>
                        </div>
                        <div>
                            <label for="ticketType" style="display: block; font-weight: bold; margin-bottom: 5px;">Issue Type:</label>
                            <select id="ticketType" style="width: 100%; padding: 8px; border: 2px solid #e9ecef; border-radius: 5px;">
                                <option value="Task" selected>Task</option>
                                <option value="Request a contract review">Request a contract review</option>
                                <option value="Questions for legal">Questions for legal</option>
                                <option value="Emailed request">Emailed request</option>
                                <option value="General request">General request</option>
                                <option value="Procurement Intake">Procurement Intake</option>
                                <option value="Sub-task">Sub-task</option>
                            </select>
                        </div>
                    </div>
    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeCreateTicketModal()" style="background: #505E74; color: white; border: none; padding: 12px 30px; border-radius: 25px; cursor: pointer; font-size: 1em; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(108, 117, 125, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">Cancel</button>
                        <button onclick="createJiraTicket()" style="background: #505E74; color: white; border: none; padding: 12px 30px; border-radius: 25px; cursor: pointer; font-size: 1em; transition: all 0.3s ease; margin: 0;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(111, 66, 193, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">Create Ticket</button>
                    </div>

                    <div class="loading" id="ticketLoading">
                        <div class="spinner"></div>
                        <p>Creating Jira ticket...</p>
                    </div>
    
                    <div class="error" id="ticketError"></div>
                    <div class="success" id="ticketSuccess" style="display: none;"></div>
                </div>
            </div>

        <!-- Tab 4: Contract Search -->
        <div id="contract-search" class="tab-content">
            <div class="section">
                <h2>Advanced Contract Search</h2>
                <p>Search contracts by name, product, or vendor information</p>
                
                <!-- Search Input Section -->
                <div style="margin: 20px 0;">
                    <div class="search-filters">
                        <div class="filter-group">
                            <label for="contractNameSearch">Contract Name</label>
                            <input type="text" id="contractNameSearch" 
                                placeholder="Enter contract name (partial matches allowed)..." 
                                style="padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1em;">
                        </div>
                        <div class="filter-group">
                            <label for="productNameSearch">Product Name</label>
                            <input type="text" id="productNameSearch" 
                                placeholder="Enter product name..." 
                                style="padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1em;">
                        </div>
                        <div class="filter-group">
                            <label for="vendorNameSearch">Vendor Name</label>
                            <input type="text" id="vendorNameSearch" 
                                placeholder="Enter vendor name..." 
                                style="padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1em;">
                        </div>
                    </div>
                    
                    <div class="button-row">
                        <button class="btn btn-search" onclick="performContractSearch()">
                            Search Contracts
                        </button>
                        <button class="btn" onclick="clearContractSearchFilters()">Clear All</button>
                    </div>
                </div>

                <div class="loading" id="contractSearchLoading">
                    <div class="spinner"></div>
                    <p id="contractSearchLoadingText">Searching Contracts...</p>
                </div>

                <div class="error" id="contractSearchError"></div>
                
                <div id="contractSearchResults"></div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let standardFile = null;
        let comparisonType = null;

        const attorneyMapping = {
            "Baker Botts L.L.P.": "Total Attorney: 700",
            "Simpson Thacher & Bartlett LLP": "Total Attorney: 1200",
            "Paul, Weiss, Rifkind, Wharton & Garrison LLP": "Total Attorney: 1000",
            "Schulte Roth & Zabel LLP": "Total Attorney: 300",
            "Chapman and Cutler LLP": "Total Attorney: 200",
            "Phillips Lytle LLP": "Total Attorney: 100",
            "Ropes & Gray LLP": "Total Attorney: 1500",
            "Harris Beach PLLC": "Total Attorney: 200",
            "Morris, Nichols, Arsht & Tunnell LLP": "Total Attorney: 100",
            "Beveridge & Diamond, PC": "Total Attorney: 100",
            "Cleary Gottlieb Steen & Hamilton LLP": "Total Attorney: 1200",
            "Kaufman Borgeest Ryan LLP - FedEx Pricing Audit": "Total Attorney: 100",
            "Adler Pollock & Sheehan PC": "Total Attorney: 100",
            "Ogletree":"Total Attorney:  900",
            "Proskauer Rose LLP": "Total Attorney: 800",
            "Bricker Graydon LLP": "Total Attorney: 200",
            "Steptoe": "Total Attorney: 400",
            "Frost Brown Todd LLP": "Total Attorney: 600",
            "Akerman LLP": "Total Attorney: 700",
            "Cadwalader, Wickersham & Taft LLP": "Total Attorney: 400",
            "Ankura Consulting Group": "Total Revenue: $800M",
            "Crash Champions": "Total Revenue: $5B"
        };

        let coopMapping = {}; // 存储客户名称到Co-op编号的映射
        let coopCounter = 1;  // Co-op编号计数器
        let isCoopMappingInitialized = false; // 标记是否已初始化

        // 2. 初始化Co-op编号映射（在显示结果前调用）
        function initializeCoopMapping(allClientNames) {
            if (isCoopMappingInitialized) return;
            
            // 收集所有不在attorneyMapping中的客户名称
            const unmappedClients = allClientNames.filter(clientName => 
                !attorneyMapping.hasOwnProperty(clientName)
            );
            
            // 排序以确保一致的编号顺序
            unmappedClients.sort();
            
            // 为每个未映射的客户分配Co-op编号
            unmappedClients.forEach(clientName => {
                if (!coopMapping[clientName]) {
                    coopMapping[clientName] = `Corp ${coopCounter}`;
                    coopCounter++;
                }
            });
            
            isCoopMappingInitialized = true;
            console.log('🏷️ Corp mapping initialized:', coopMapping);
        }

        // 3. 修改 getAttorneyDisplay 函数
        function getAttorneyDisplay(clientName) {
            if (attorneyMapping.hasOwnProperty(clientName)) {
                return `${attorneyMapping[clientName]}`;
            }
            
            // 返回已分配的Co-op编号
            return coopMapping[clientName] || 'Corp';
        }

        function getAttorneyDisplay(clientName) {
            if (attorneyMapping.hasOwnProperty(clientName)) {
                return `${attorneyMapping[clientName]}`;
            }
            return "Corp";
        }

        // Client mapping (same as server)
        const clientMapping = {
            4: "Alston & Bird LLP", 5: "Ruden McClosky", 6: "Dykema Gossett PLLC", 8: "Miller & Martin PLLC",
            9: "Hogan Lovells US LLP", 10: "Cranfill, Sumner, & Hartzog, L.L.P.", 12: "Poyner & Spruill LLP",
            13: "Warner Norcross & Judd", 14: "Olshan Frome Wolosky LLP", 15: "Cadwalader, Wickersham & Taft LLP",
            16: "Baker & Hostetler LLP", 17: "Brown Rudnick LLP", 18: "Phillips Lytle LLP", 19: "Andrews Kurth LLP",
            20: "Miller & Chevalier", 21: "Baker, Donelson, Bearman, Caldwell & Berkowitz PC", 22: "Jones Vargas",
            23: "Paul, Weiss, Rifkind, Wharton & Garrison LLP", 24: "Robins Kaplan LLP", 26: "Ropes & Gray LLP",
            27: "Royston, Rayzor, Vickery & Williams, L.L.P.", 28: "Vinson & Elkins L.L.P.", 30: "Wilson Sonsini Goodrich & Rosati",
            31: "Stinson Leonard Street", 32: "Bank Street College of Education", 33: "Keker & Van Nest L.L.P.",
            34: "ESL Federal Credit Union", 35: "Chamberlain, Hrdlicka, White, Williams & Martin", 36: "Meagher & Geer, P.L.L.P.",
            37: "Farella Braun & Martel LLP", 38: "Bingham McHale LLP", 39: "Wolf Haldenstein Adler Freeman & Herz LLP",
            40: "Nixon Peabody LLP", 41: "Gray Plant Mooty", 42: "Schiff Hardin LLP", 43: "Procopio, Cory, Hargreaves & Savitch LLP",
            44: "Akin Gump Strauss Hauer & Feld LLP", 45: "Sterne, Kessler, Goldstein & Fox P.L.L.C.", 46: "Snell & Wilmer L.L.P.",
            47: "Parker Poe Adams & Berstein LLP", 48: "Seward & Kissel LLP", 49: "Burns & Levinson LLP",
            50: "Smith, Anderson, Blount, Dorsett, Mitchell & Jernigan, L.L.P", 51: "McDonough, Holland & Allen PC",
            52: "Zelle, Hofmann, Voelbel & Mason LLP", 53: "Litchfield Cavo LLP", 54: "Margolin, Winer & Evens LLP",
            55: "Gallaudet University", 56: "Quarles & Brady LLP", 57: "McNees Wallace & Nurick LLC", 58: "Bingham McCutchen LLP",
            59: "McGlinchey Stafford PLLC", 60: "Carlton Fields Jorden Burt", 62: "Davis Polk & Wardwell LLP",
            63: "Faegre & Benson LLP", 64: "Morrison & Foerster LLP", 65: "Montgomery, McCracken, Walker & Rhoads, LLP",
            66: "Holland & Knight LLP", 67: "Rawle & Henderson LLP", 68: "Winthrop & Weinstine, P.A.",
            69: "Lindabury, McCormick, Estabrook & Cooper, P.C.", 70: "Blake, Cassels & Graydon LLP",
            71: "Cassels Brock & Blackwell LLP", 72: "Fasken Martineau DuMoulin LLP", 73: "Fraser Milner Casgrain LLP",
            74: "Goodmans LLP", 75: "Gowling Lafleur Henderson LLP", 76: "Heenan Blaikie LLP", 77: "McMillan LLP",
            78: "McCarthy Tétrault LLP", 79: "Norton Rose Fulbright Canada LLP", 80: "Torys LLP", 81: "Osler, Hoskin & Harcourt LLP",
            82: "Stikeman Elliott LLP", 83: "O'Melveny & Myers LLP", 84: "Hirschler Fleischer", 85: "Lewis, Rice & Fingersh, L.C.",
            87: "Stikeman Elliott LLP (WAVG)", 88: "Anderson Kill & Olick, PC", 89: "Calfee, Halter & Griswold LLP",
            90: "Torys LLP (NY)", 91: "Miller Thomson LLP", 92: "Allen & Overy LLP", 93: "Osler, Hoskin & Harcourt LLP (New York)",
            94: "K&L Gates LLP", 95: "Jenner & Block LLP", 96: "Genesis HealthCare Corporation 1-200", 97: "Health Plus",
            98: "Li & Fung USA", 99: "Fisher & Phillips LLP", 100: "Irving Place Capital", 101: "Jennings, Strouss & Salmon, P.L.C.",
            102: "Wilkinson Barker Knauer, LLP", 103: "Day Pitney LLP", 104: "Wegmans Food Markets", 105: "Kobre & Kim LLP",
            106: "Global Brands Group", 107: "Baker Botts L.L.P.", 108: "Holy Redeemer Health System", 109: "Swiss Re Management (US) Corporation",
            110: "Geller & Company", 111: "Miller, Canfield, Paddock & Stone", 112: "Borden Ladner Gervais", 113: "Tulane University",
            115: "MRC Global", 116: "Reyes Holdings", 118: "Hawkins Parnell & Young LLP", 119: "McIness Cooper", 121: "Stewart McKelvey",
            122: "Graydon Head & Ritchey LLP", 123: "ZZZZ", 124: "The Kenan Advantage Group - Staples", 125: "Mayer Brown LLP",
            126: "U.S. Security Associates, Inc.", 127: "The Hershey Company", 128: "Norris McLaughlin & Marcus, P.A.",
            129: "Genesis HealthCare Corporation 201-400", 130: "Genesis HealthCare Corporation 401-600", 131: "Constangy, Brooks, Smith & Prophete, LLP",
            132: "McAfee Taft LLP", 133: "PSS Companies", 134: "Harris Beach PLLC", 135: "Montefiore Health Systems",
            136: "GCA Services Group", 137: "Morris, Nichols, Arsht & Tunnell LLP", 138: "Kelley Drye & Warren LLP",
            139: "Neopost USA", 140: "Chiesa Shahinian & Giantomasi PC", 141: "TZP Group", 142: "Manning Gross + Massenburg LLP (MG+M The Law Firm)",
            143: "Beveridge & Diamond, PC", 148: "Young Conaway Stargatt & Taylor, LLP", 149: "Buckley LLP", 150: "The Kenan Advantage Group-Office Depot",
            151: "Mount Sinai Health Systems", 153: "Zelle LLP", 154: "Sterling", 155: "Strategic Financial Solutions",
            156: "Capital Vision", 157: "The Carpenter Health Network", 158: "Mt Sinai Health Systems Toner School",
            159: "Mt Sinai Health Systems Reports", 160: "Commonwealth Care Alliance", 161: "Cleary Gottlieb Steen & Hamilton LLP",
            162: "Kaufman Borgeest Ryan LLP - FedEx Pricing Audit", 163: "Simpson Thacher & Bartlett LLP", 164: "Winget, Spadafora & Schwartzberg, LLP",
            165: "Advanced Recovery Systems, LLC", 166: "Diversified", 167: "Monotype", 168: "Skadden, Arps, Slate, Meagher & Flom LLP",
            169: "HERRICK FEINSTEIN LLP", 170: "Armstrong Flooring", 171: "Berger & Montague P.C.", 172: "Robinson Bradshaw & Hinson PA",
            173: "Archer & Greiner, P.C.", 174: "McCarter & English", 175: "Hospital for Special Care", 176: "Ballard Spahr",
            177: "Ballard Spahr", 178: "Shumaker, Loop & Kendrick", 179: "Dorsey & Whitney", 180: "Munger, Tolles & Olson",
            181: "Paul Hastings", 182: "Nelson Mullins Riley & Scarborough", 183: "Davis Wright Tremaine", 184: "Stoel Rives",
            185: "Blank Rome", 186: "Invesco ltd", 187: "Promedica", 188: "Davis Polk", 191: "Monarch Healthcare",
            192: "Genesis HealthCare", 193: "Big Lift LLC", 194: "Invesco", 195: "IB Goodman", 196: "Sentrilock, LLC",
            197: "United Courier", 198: "Reliant Healthcare", 199: "Keller & Heckman", 200: "Chapman and Cutler LLP",
            201: "Schulte Roth & Zabel LLP", 202: "Maplewood Senior Living", 203: "Food to Live", 204: "Enexia Specialty Pharmacy",
            205: "GLDN", 206: "Precision Compounding Pharmacy and Wellness", 207: "GHC", 208: "Demo Client", 209: "MBK Senior Living",
            210: "Calavo", 211: "Huntons Andrew Kurth", 212: "Adler Pollock & Sheehan PC", 213: "Moses & Singer LLP",
            214: "SavaSeniorCare, LLC", 215: "Bond, Schoeneck & King", 216: "American Broadcasting Company (ABC)", 217: "Brownstein Hyatt Farber Schreck",
            218: "Carter Ledyard & Milburn", 219: "Condon & Forsyth LLP", 220: "Cravath, Swaine & Moore", 221: "Finn Dixon & Herling",
            222: "Foley & Lardner", 223: "Katten Muchin Rosenman", 224: "Kirkland & Ellis", 225: "Manatt, Phelps & Phillips",
            226: "Milbank", 227: "Pace LLP", 228: "Proskauer Rose LLP", 229: "Zuckerman Spaeder", 230: "Greenberg Traurig",
            231: "Care Initiatives", 232: "Stamford JCC", 233: "Natures Sunshine", 234: "Legacy Senior Living",
            235: "Healthcare Services Group", 236: "Willkie Farr & Gallagher LLP", 237: "Freshfields", 238: "Shalby Advanced Technologies",
            239: "Elara Caring", 240: "Ogletree Deakins", 241: "Ogletree Deakins benchm", 242: "C Spire", 243: "Consensus Health",
            244: "ENT and Allergy Associates", 245: "Anderson Automotive Group", 246: "Bricker Graydon LLP", 247: "Pulmonary Exchange",
            248: "Bria", 249: "Internal Portal", 250: "Frost Brown Todd LLP", 251: "Imagination Technologies", 252: "DocGo",
            253: "Prospect Demo", 254: "Transitions Healthcare LLC", 255: "Crash Champions", 256: "HWG LLP", 257: "PL Development",
            258: "Super Natural Distributors", 259: "Steptoe", 260: "Windy City", 261: "House of Cheatham", 262: "CareAbout Health",
            263: "Sullivan & Cromwell", 265: "Baker Botts", 266: "Morrison Cohen LLP",
            264: "Ankura Consulting Group", 268: "Small Demo", 269: "Akerman LLP"
        };

        function parseGLDate(dateStr) {
            if (!dateStr) return 'N/A';
            
            try {
                // 处理 MM/d/yy HH:mm 格式，如 "12/7/22 00:00"
                const dateMatch = dateStr.toString().match(/^(\d{1,2})\/(\d{1,2})\/(\d{2})\s/);
                
                if (dateMatch) {
                    const month = parseInt(dateMatch[1]);
                    const day = parseInt(dateMatch[2]);
                    let year = parseInt(dateMatch[3]);
                    
                    // 将两位数年份转换为四位数
                    // 假设22表示2022，不是1922
                    if (year < 50) {
                        year += 2000; // 00-49 -> 2000-2049
                    } else {
                        year += 1900; // 50-99 -> 1950-1999
                    }
                    
                    return year;
                }
                
                // 如果匹配失败，尝试直接解析
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    return date.getFullYear();
                }
                
                // 如果都失败了，返回原始字符串的前几个字符作为参考
                return dateStr.toString().substring(0, 8) + '...';
                
            } catch (error) {
                console.warn('Could not parse GL date:', dateStr, error);
                return 'Invalid Date';
            }
        }

        function switchTab(tabId) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });

        // Remove active class from all tab buttons
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });

        // Show selected tab content
        document.getElementById(tabId).classList.add('active');

        // Add active class to clicked tab button
        event.target.classList.add('active');

        // Initialize specific tab functionality
        if (tabId === 'ai-assistant') {
            console.log('AI Assistant tab activated');
        } else if (tabId === 'search-jira') {
            if (!mainFiltersLoaded) {
                loadMainFilterOptions();
            }
            if (!vendorsLoaded) {
                loadVendorSuggestions();
            }
            resetCoopMapping();
            if (typeof selectedVendors === 'undefined') {
                selectedVendors = [];
            }
        } else if (tabId === 'contract-search') {
            console.log('Contract Search tab activated');
            // Clear any previous search results when switching to this tab
            clearContractSearchFilters();
        }
    }

        document.addEventListener('DOMContentLoaded', function() {
            if (window.appInitialized) {
                console.log('📋 App already initialized, skipping...');
                return;
            }
            window.appInitialized = true;
            
            console.log('📋 Initializing app...');
            
            // Drag and drop functionality
            document.querySelectorAll('.upload-area').forEach(area => {
                area.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    area.classList.add('dragover');
                });

                area.addEventListener('dragleave', () => {
                    area.classList.remove('dragover');
                });

                area.addEventListener('drop', (e) => {
                    e.preventDefault();
                    area.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        if (area.querySelector('#contractFile')) {
                            handleFileUpload({files: files});
                        } else {
                            handleStandardUpload({files: files});
                        }
                    }
                });
            });

            // 只初始化一次
            loadMainFilterOptions();
            loadVendorSuggestions();
            
            // Initialize chatbot
            const messagesContainer = document.getElementById('chatbotMessages');
            if (messagesContainer && messagesContainer.children.length <= 1) {
                clearConversation();
            }
            
            console.log('✅ App initialization completed');
        });

        function handleFileUpload(input) {
            const file = input.files ? input.files[0] : input;
            if (file) {
                selectedFile = file;
                const fileInfo = document.getElementById('fileInfo');
                fileInfo.innerHTML = 
                    '<strong>Selected File:</strong> ' + file.name + '<br>' +
                    '<strong>Size:</strong> ' + (file.size / 1024 / 1024).toFixed(2) + ' MB<br>' +
                    '<strong>Type:</strong> ' + (file.type || 'Unknown');
                fileInfo.style.display = 'block';
                
                // Show comparison section when file is uploaded
                document.getElementById('comparisonSection').style.display = 'block';
                checkAnalysisReady();
            }
        }

        function handleStandardUpload(input) {
            const file = input.files ? input.files[0] : input;
            if (file) {
                standardFile = file;
                const fileInfo = document.getElementById('standardFileInfo');
                fileInfo.innerHTML = 
                    '<strong>Standard Template:</strong> ' + file.name + '<br>' +
                    '<strong>Size:</strong> ' + (file.size / 1024 / 1024).toFixed(2) + ' MB';
                fileInfo.style.display = 'block';
                checkAnalysisReady();
            }
        }

        // Main search functionality for the second tab
        function handleMainSearchKeyPress(event) {
            if (event.key === 'Enter') {
                const input = event.target;
                const value = input.value.trim();
                
                if (value && !selectedVendors.find(v => v.toLowerCase() === value.toLowerCase())) {
                    addSelectedVendor(value);
                } else if (selectedVendors.length > 0 || document.getElementById('mainFilterClient').getAttribute('data-selected-clnums')) {
                    searchContractsAndJira();
                }
            }
        }

        let selectedVendors = [];

        // 修改 loadVendorSuggestions 函数，添加缓存
        let allVendors = [];
        let vendorsLoaded = false;

        // 修复loadVendorSuggestions函数，添加更强的防重复逻辑：
        async function loadVendorSuggestions() {
            if (vendorsLoaded) {
                console.log('📋 Vendors already loaded, skipping...');
                return;
            }
            
            // 立即设置标记，防止并发调用
            vendorsLoaded = true;
            
            try {
                console.log('📝 Loading vendor suggestions...');
                const response = await fetch('/api/vendors/list');
                if (!response.ok) {
                    console.warn('Could not load vendor suggestions:', response.status);
                    allVendors = [];
                    return;
                }
                
                const vendorData = await response.json();
                
                // 客户端去重逻辑
                const vendorMap = new Map();
                
                vendorData.forEach(vendor => {
                    const lowerCaseName = vendor.vendor_name.toLowerCase();
                    
                    if (vendorMap.has(lowerCaseName)) {
                        const existing = vendorMap.get(lowerCaseName);
                        const allSources = [...new Set([...existing.sources, ...vendor.sources])];
                        vendorMap.set(lowerCaseName, {
                            name: existing.name,
                            sources: allSources
                        });
                    } else {
                        vendorMap.set(lowerCaseName, {
                            name: vendor.vendor_name,
                            sources: vendor.sources
                        });
                    }
                });
                
                allVendors = Array.from(vendorMap.values());
                
                console.log('📝 Loaded', allVendors.length, 'unique vendors (case-insensitive)');
                console.log('📝 Original count:', vendorData.length, 'Deduplicated:', allVendors.length);
                
            } catch (error) {
                console.error('❌ Error loading vendor suggestions:', error);
                allVendors = [];
                vendorsLoaded = false; // 重置标记以便重试
            }
        }

        function showVendorSuggestions(query) {
            const suggestionsDiv = document.getElementById('vendorSuggestions');
            
            if (query.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            const selectedVendorNames = selectedVendors.map(v => v.toLowerCase());
            const matches = allVendors.filter(vendor => 
                vendor.name.toLowerCase().includes(query.toLowerCase()) && 
                !selectedVendorNames.includes(vendor.name.toLowerCase())
            ).slice(0, 15);

            if (matches.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            let suggestionsHtml = '';
            matches.forEach(vendor => {
                // Display vendor name as-is (no forced lowercase)
                suggestionsHtml += `
                    <div class="vendor-suggestion-item" onclick="addSelectedVendor('${vendor.name.replace(/'/g, '\\\'')}')" 
                        style="padding: 8px 12px;">
                        <span>${vendor.name}</span>
                    </div>
                `;
            });

            suggestionsDiv.innerHTML = suggestionsHtml;
            suggestionsDiv.style.display = 'block';
        }

        function addSelectedVendor(vendorName) {
            if (selectedVendors.find(v => v.toLowerCase() === vendorName.toLowerCase())) {
                return;
            }

            // 只添加vendor名称，不包含来源信息
            selectedVendors.push(vendorName);
            
            document.getElementById('mainSearchInput').value = '';
            document.getElementById('vendorSuggestions').style.display = 'none';
            
            updateSelectedVendorsDisplay();
            
            console.log('📝 Added vendor:', vendorName);
        }

        function removeSelectedVendor(vendorName) {
            selectedVendors = selectedVendors.filter(v => v !== vendorName);
            updateSelectedVendorsDisplay();
        }

        function updateSelectedVendorsDisplay() {
            const selectedVendorsDiv = document.getElementById('selectedVendors');
            
            // Use DocumentFragment for better performance with many vendors
            const fragment = document.createDocumentFragment();
            
            selectedVendors.forEach(vendor => {
                const tag = document.createElement('div');
                tag.className = 'selected-vendor-tag';
                tag.innerHTML = `
                    <span class="vendor-name" title="${vendor}">${vendor}</span>
                    <button class="remove-vendor" onclick="removeSelectedVendor('${vendor.replace(/'/g, '\\\'')}')" title="Remove ${vendor}">×</button>
                `;
                fragment.appendChild(tag);
            });
            
            selectedVendorsDiv.innerHTML = '';
            selectedVendorsDiv.appendChild(fragment);
        }

        function clearSelectedVendors() {
            selectedVendors = [];
            updateSelectedVendorsDisplay();
        }

        async function searchContractsAndJira() {
            const searchTerm = document.getElementById('mainSearchInput').value.trim();
            const filterType = document.getElementById('mainFilterType').value;
            const filterStatus = document.getElementById('mainFilterStatus').value;
            const filterTicketStatus = document.getElementById('mainFilterTicketStatus').value;
            
            // Get selected search types
            const searchTypeCheckboxes = document.querySelectorAll('input[name="searchType"]:checked');
            const selectedSearchTypes = Array.from(searchTypeCheckboxes).map(cb => cb.value);

            if (selectedSearchTypes.length === 0) {
                showMainError('Please select at least one search type');
                return;
            }

            // Updated search criteria validation (removed client checks)
            const hasSearchTerm = searchTerm && searchTerm.length > 0;
            const hasVendors = selectedVendors && selectedVendors.length > 0;
            const hasContractType = filterType && filterType.length > 0;
            const hasContractStatus = filterStatus && filterStatus.length > 0;
            const hasTicketStatus = filterTicketStatus && filterTicketStatus.length > 0;
            
            // Check date filters
            const hasStartDateFrom = document.getElementById('contractStartDateFrom').value;
            const hasStartDateTo = document.getElementById('contractStartDateTo').value;
            const hasEndDateFrom = document.getElementById('contractEndDateFrom').value;
            const hasEndDateTo = document.getElementById('contractEndDateTo').value;
            const hasDateFilters = hasStartDateFrom || hasStartDateTo || hasEndDateFrom || hasEndDateTo;

            // Updated validation (removed hasClients check)
            if (!hasSearchTerm && !hasVendors && !hasContractType && 
                !hasContractStatus && !hasTicketStatus && !hasDateFilters) {
                showMainError('Please provide at least one search criteria: vendor, status, date range, or search term');
                return;
            }

            try {
                let loadingText = 'Searching';
                if (selectedSearchTypes.length > 1) {
                    loadingText += ` ${selectedSearchTypes.join(', ')}...`;
                } else {
                    loadingText += ` ${selectedSearchTypes[0]}...`;
                }
                
                showMainLoading(true, loadingText);
                hideMainError();

                let contractsPromise = Promise.resolve([]);
                let jiraPromise = Promise.resolve([]);
                let glPromise = Promise.resolve([]);

                // Search based on selected types (remove selectedClientClnums parameters)
                if (selectedSearchTypes.includes('contracts')) {
                    contractsPromise = searchContracts(searchTerm, filterType, filterStatus, selectedVendors);
                }
                
                if (selectedSearchTypes.includes('jira')) {
                    jiraPromise = searchJiraTickets(searchTerm, filterTicketStatus, selectedVendors);
                }
                
                if (selectedSearchTypes.includes('gl')) {
                    glPromise = searchGL(searchTerm, selectedVendors);
                }

                const [contractsResult, jiraResult, glResult] = await Promise.all([contractsPromise, jiraPromise, glPromise]);

                displayCombinedResults(contractsResult, jiraResult, glResult, searchTerm, selectedSearchTypes);

            } catch (error) {
                console.error('Combined search failed:', error);
                showMainError('Search failed: ' + error.message);
            } finally {
                showMainLoading(false);
            }
        }

        async function searchGL(searchTerm, vendors) {
            try {
                const requestBody = {};
                
                // Initialize properly
                let whereConditions = [];
                let params = [];
                
                if (searchTerm && searchTerm.trim()) {
                    requestBody.searchTerm = searchTerm.trim();
                }

                if (vendors && vendors.length > 0) {
                    requestBody.vendors = vendors;
                }

                console.log('💰 Searching GL records with:', requestBody);

                const [glResponse, filterResponse] = await Promise.all([
                    fetch('/api/gl/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    }),
                    fetch('/api/gl/filter-options', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    })
                ]);

                if (!glResponse.ok) {
                    const errorData = await glResponse.json();
                    throw new Error(errorData.error || 'GL search failed');
                }

                if (!filterResponse.ok) {
                    console.warn('Failed to load filter options, using data from results');
                }

                const glData = await glResponse.json();
                const filterData = filterResponse.ok ? await filterResponse.json() : { success: false };

                const result = glData.records || [];
                result.filterOptions = filterData.success ? filterData.filterOptions : null;

                return result;

            } catch (error) {
                console.error('GL search failed:', error);
                return [];
            }
        }

        async function searchContracts(searchTerm, filterType, filterStatus, vendors) {
            let results = [];

            const startDateFromFilter = document.getElementById('contractStartDateFrom').value;
            const startDateToFilter = document.getElementById('contractStartDateTo').value;
            const endDateFromFilter = document.getElementById('contractEndDateFrom').value;
            const endDateToFilter = document.getElementById('contractEndDateTo').value;

            // Build search parameters
            const params = new URLSearchParams();
            params.append('limit', '200');
            
            if (filterType) params.append('type', filterType);
            if (filterStatus) params.append('status', filterStatus);
            
            // Handle multiple vendors
            if (vendors && vendors.length > 0) {
                params.append('vendors', vendors.join(','));
                console.log('📄 Adding vendors to contract search:', vendors);
            } else if (searchTerm && searchTerm.trim()) {
                params.append('q', searchTerm);
                console.log('📄 Adding search term to contract search:', searchTerm);
            }

            // Choose correct API endpoint
            let url;
            if (searchTerm && searchTerm.trim() && !vendors?.length) {
                url = '/api/contracts/search?' + params.toString();
            } else {
                url = '/api/contracts?' + params.toString();
            }

            console.log('📄 Contract search URL:', url);

            try {
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Contract search failed');
                }

                const data = await response.json();
                results = data.contracts || [];

                // Apply date filters on client side
                if (startDateFromFilter || startDateToFilter || endDateFromFilter || endDateToFilter) {
                    results = results.filter(contract => {
                        const contractStartDate = formatDateFromNumber(contract.start_date);
                        const contractEndDate = formatDateFromNumber(contract.end_date);
                        
                        if ((startDateFromFilter || startDateToFilter) && (contractStartDate === 'N/A' || !contractStartDate)) {
                            return false;
                        }
                        
                        if ((endDateFromFilter || endDateToFilter) && (contractEndDate === 'N/A' || !contractEndDate)) {
                            return false;
                        }
                        
                        let matchesDateRange = true;
                        
                        if (startDateFromFilter && contractStartDate && contractStartDate !== 'N/A') {
                            matchesDateRange = matchesDateRange && (contractStartDate >= startDateFromFilter);
                        }
                        
                        if (startDateToFilter && contractStartDate && contractStartDate !== 'N/A') {
                            matchesDateRange = matchesDateRange && (contractStartDate <= startDateToFilter);
                        }
                        
                        if (endDateFromFilter && contractEndDate && contractEndDate !== 'N/A') {
                            matchesDateRange = matchesDateRange && (contractEndDate >= endDateFromFilter);
                        }
                        
                        if (endDateToFilter && contractEndDate && contractEndDate !== 'N/A') {
                            matchesDateRange = matchesDateRange && (contractEndDate <= endDateToFilter);
                        }
                        
                        return matchesDateRange;
                    });
                }

                // Sort by amount
                results.sort((a, b) => {
                    const spendA = parseFloat(a.spend) || 0;
                    const spendB = parseFloat(b.spend) || 0;
                    return spendB - spendA;
                });

                console.log('📄 Contract search completed, found:', results.length, 'contracts');
                return results;

            } catch (error) {
                console.error('Contract search failed:', error);
                throw error;
            }
        }

        // 完整的 Jira 搜索函数
        async function searchJiraTickets(searchTerm, filterTicketStatus, vendors) {
            try {
                const requestBody = {};
                
                if (searchTerm && searchTerm.trim()) {
                    requestBody.searchTerm = searchTerm.trim();
                }

                if (filterTicketStatus) {
                    requestBody.ticketStatus = filterTicketStatus;
                }

                if (vendors && vendors.length > 0) {
                    requestBody.vendors = vendors;
                }

                console.log('🎫 Searching Jira tickets with:', requestBody);

                const response = await fetch('/api/jira/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('🎫 Jira API Error:', errorData);
                    throw new Error(errorData.error || 'Jira search failed');
                }

                const data = await response.json();
                console.log('🎫 Jira search completed, found:', data.tickets?.length || 0, 'tickets');
                
                return data.tickets || [];

            } catch (error) {
                console.error('🎫 Jira search failed:', error);
                return [];
            }
        }

        function displayCombinedResults(contracts, jiraTickets, glRecords, searchTerm, selectedSearchTypes) {
            const resultsDiv = document.getElementById('mainResults');
            
            if (!resultsDiv) {
                console.error('❌ mainResults div not found!');
                return;
            }
            
            // 🔥 重要：在处理数据前收集所有客户名称并初始化Co-op映射
            const allClientNames = new Set();
            
            // 从contracts收集客户名称
            if (contracts && contracts.length > 0) {
                contracts.forEach(contract => {
                    const clnumKey = parseInt(contract.clnum);
                    const clientName = clientMapping[clnumKey] || `Client ${contract.clnum}`;
                    allClientNames.add(clientName);
                });
            }
            
            // 从GL records收集客户名称
            if (glRecords && glRecords.length > 0) {
                glRecords.forEach(record => {
                    if (record.filterOptions) return;
                    // 使用从服务器返回的 client_name 字段（已解密）
                    const clientName = record.client_name || record.clname || '';
                    if (clientName) {
                        allClientNames.add(clientName);
                    }
                });
            }
            
            // 初始化Co-op映射
            initializeCoopMapping(Array.from(allClientNames));
            
            console.log('📊 Display results:', { 
                contracts: contracts?.length || 0, 
                jiraTickets: jiraTickets?.length || 0, 
                glRecords: glRecords?.length || 0 
            });
            
            // Create summary
            let summaryHtml = '<div class="results-summary">' +
                '<h3>Search Results Summary</h3>' +
                '<div class="summary-stats">';
            
            if (selectedSearchTypes.includes('contracts')) {
                summaryHtml += '<div class="stat-item">' +
                    '<div class="stat-number">' + (contracts?.length || 0) + '</div>' +
                    '<div class="stat-label">Contracts Found</div>' +
                    '</div>';
            }
            
            if (selectedSearchTypes.includes('jira')) {
                summaryHtml += '<div class="stat-item">' +
                    '<div class="stat-number">' + (jiraTickets?.length || 0) + '</div>' +
                    '<div class="stat-label">Jira Tickets Found</div>' +
                    '</div>';
            }
            
            if (selectedSearchTypes.includes('gl')) {
                summaryHtml += '<div class="stat-item">' +
                    '<div class="stat-number">' + (glRecords?.length || 0) + '</div>' +
                    '<div class="stat-label">GL Records Found</div>' +
                    '</div>';
            }
            
            const totalResults = (contracts?.length || 0) + (jiraTickets?.length || 0) + (glRecords?.length || 0);
            summaryHtml += '<div class="stat-item">' +
                '<div class="stat-number">' + totalResults + '</div>' +
                '<div class="stat-label">Total Results</div>' +
                '</div>';
            
            summaryHtml += '</div></div>';

            // Build Contracts HTML
            let contractsHtml = '';
            if (selectedSearchTypes.includes('contracts')) {
                if (contracts && contracts.length > 0) {
                    // Collect all unique attorney display options for client filter
                    const contractClientOptions = [];
                    const contractVendorOptions = [];
                    
                    contracts.forEach(contract => {
                        const clnumKey = parseInt(contract.clnum);
                        const clientName = clientMapping[clnumKey] || `Client ${contract.clnum}`;
                        const attorneyDisplay = getAttorneyDisplay(clientName);
                        if (!contractClientOptions.includes(attorneyDisplay)) {
                            contractClientOptions.push(attorneyDisplay);
                        }
                        
                        // FIXED: Case-insensitive vendor deduplication
                        if (contract.vendor_name) {
                            const vendorName = contract.vendor_name.trim();
                            const exists = contractVendorOptions.some(v => 
                                v.toLowerCase() === vendorName.toLowerCase()
                            );
                            if (!exists) {
                                contractVendorOptions.push(vendorName);
                            }
                        }
                    });
                    
                    contractClientOptions.sort();
                    contractVendorOptions.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

                    contractsHtml = '<div class="search-results-section">' +
                        '<h3>Contracts</h3>' +
                        '<p style="margin-bottom: 15px; color: #6c757d;">Found ' + contracts.length + ' contract(s)</p>' +
                        
                        // Contract table filters with deduplicated vendor filter
                        '<div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">' +
                        '<h4 style="margin-bottom: 15px; color: #495057;">Contract Filters</h4>' +
                        '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">' +
                        '<div>' +
                        '<label style="font-size: 0.9em; font-weight: bold; color: #495057; display: block; margin-bottom: 5px;">Client:</label>' +
                        '<select id="contractClientFilter" onchange="filterContractTable()" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9em; background-color: white;">' +
                        '<option value="">All Clients</option>';
                    
                    contractClientOptions.forEach(option => {
                        contractsHtml += '<option value="' + option.replace(/"/g, '&quot;') + '">' + option + '</option>';
                    });
                    
                    contractsHtml += '</select>' +
                        '</div>' +
                        '<div>' +
                        '<label style="font-size: 0.9em; font-weight: bold; color: #495057; display: block; margin-bottom: 5px;">Vendor:</label>' +
                        '<select id="contractVendorFilter" onchange="filterContractTable()" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9em; background-color: white;">' +
                        '<option value="">All Vendors</option>';
                    
                    // Add deduplicated vendor options
                    contractVendorOptions.forEach(vendor => {
                        contractsHtml += '<option value="' + vendor.replace(/"/g, '&quot;') + '">' + vendor + '</option>';
                    });
                    
                    contractsHtml += '</select>' +
                        '</div>' +
                        '<div style="display: flex; align-items: end;">' +
                        '<button onclick="clearContractFilters()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">Clear Filters</button>' +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        
                        '<div style="overflow-x: auto;">' +
                        '<table class="contracts-table" id="contractTable">' +
                        '<thead><tr>' +
                        '<th class="col-contract-id">Contract ID</th>' +
                        '<th class="col-client">Client</th>' +
                        '<th class="col-contract-name">Contract Name</th>' +
                        '<th class="col-vendor">Vendor</th>' +
                        '<th class="col-product">Product/Service</th>' +
                        '<th class="col-period">Contract Period</th>' +
                        '<th class="col-spend">Spend</th>' +
                        '<th class="col-file">Actions</th>' +
                        '</tr></thead>' +
                        '<tbody id="contractTableBody">';

                    contracts.forEach(contract => {
                        const clnumKey = parseInt(contract.clnum);
                        const clientName = clientMapping[clnumKey] || `Client ${contract.clnum}`;
                        const attorneyDisplay = getAttorneyDisplay(clientName);
                        
                        const spendDisplay = contract.spend
                            ? (contract.currency
                                ? contract.currency + formatNumber(contract.spend)
                                : '$' + formatNumber(contract.spend))
                            : '$0.00';

                        const productDisplay = contract.product ? contract.product : 'N/A';
                        
                        let fixedFileUrl = contract.file;
                        if (fixedFileUrl && fixedFileUrl.includes('ccm-contracts.s3.amazonaws.com')) {
                            fixedFileUrl = fixedFileUrl.replace('ccm-contracts.s3.amazonaws.com', 'ccm-contracts.s3.us-east-1.amazonaws.com');
                        }
                        
                        // ✅ 新代码（添加了 data-contract-id 属性）
                        contractsHtml += '<tr class="contract-data-row" ' +
                            'data-client="' + attorneyDisplay + '" ' +
                            'data-vendor="' + (contract.vendor_name || '') + '" ' +
                            'data-contract-id="' + (contract.id || contract.contract_id || contract.clnum) + '">' +
                            '<td class="col-contract-id">' + (contract.contract_id || contract.id || 'N/A') + '</td>' +
                            '<td class="col-client"><strong>' + attorneyDisplay + '</strong></td>' +
                            '<td class="col-contract-name">' + (contract.contract_name || 'N/A') + '</td>' +
                            '<td class="col-vendor">' + (contract.vendor_name || 'N/A') + '</td>' +
                            '<td class="col-product"><div class="product-cell">' + productDisplay + '</div></td>' +
                            '<td class="col-period">' + 
                            '<div style="font-size: 0.85em;">' +
                            '<strong>Start:</strong> ' + formatDateFromNumber(contract.start_date) + '<br>' +
                            '<strong>End:</strong> ' + formatDateFromNumber(contract.end_date) +
                            '</div></td>' +
                            '<td class="col-spend">' + spendDisplay + '</td>' +
                            '<td class="col-file">' + 
                            (fixedFileUrl ? 
                                '<button onclick="previewFile(\'' + fixedFileUrl + '\')" style="background: #1e3a8a; color: white; border: none; padding: 3px 6px; border-radius: 4px; cursor: pointer; font-size: 0.75em; margin-bottom: 3px; width: 100%;">Preview</button><br>' +
                                '<button onclick="downloadFile(\'' + fixedFileUrl + '\', \'' + (contract.contract_name || 'contract') + '\')" style="background: #3b82f6; color: white; border: none; padding: 3px 6px; border-radius: 4px; cursor: pointer; font-size: 0.75em; margin-bottom: 3px; width: 100%;">Download</button><br>' +
                                '<button onclick="compareWithNew(\'' + fixedFileUrl + '\', \'' + (contract.contract_name || 'New Contract').replace(/'/g, '\\\'') + '\')" style="background: #fbbf24; color: #1f2937; border: none; padding: 3px 6px; border-radius: 4px; cursor: pointer; font-size: 0.75em; width: 100%;">Compare</button>'
                                : '<span style="color: #6c757d; font-size: 0.8em;">No file</span>'
                            ) +
                            '</td></tr>';
                    });

                    contractsHtml += '</tbody></table></div></div>';
                } else {
                    contractsHtml = '<div class="search-results-section">' +
                        '<h3>Contracts</h3>' +
                        '<p>No contracts found matching your search criteria.</p>' +
                        '</div>';
                }
            }

            // Build Jira tickets HTML
            let jiraHtml = '';
            if (selectedSearchTypes.includes('jira')) {
                if (jiraTickets && jiraTickets.length > 0) {
                    jiraHtml = '<div class="jira-section">' +
                        '<h3>Jira Tickets</h3>' +
                        '<p style="margin-bottom: 15px; color: #6c757d;">Found ' + jiraTickets.length + ' related ticket(s), click the ticket ID to view the ticket in Jira</p>' +
                        '<div style="overflow-x: auto;">' +
                        '<table class="tickets-table">' +
                        '<thead><tr>' +
                        '<th>ID</th>' +
                        '<th>Summary</th>' +
                        '<th>Status</th>' +
                        '<th>Priority</th>' +
                        '<th>Assignee</th>' +
                        '<th>Updated</th>' +
                        '</tr></thead><tbody>';

                    jiraTickets.forEach(ticket => {
                        jiraHtml += '<tr>' +
                            '<td><a href="https://ccmchase.atlassian.net/browse/' + ticket.id + '" target="_blank" class="jira-ticket-link">' + ticket.id + '</a></td>' +
                            '<td>' + ticket.summary + '</td>' +
                            '<td><span class="' + getStatusBadgeClass(ticket.status) + '">' + ticket.status + '</span></td>' +
                            '<td><span class="' + getPriorityBadgeClass(ticket.priority) + '">' + ticket.priority + '</span></td>' +
                            '<td>' + ticket.assignee + '</td>' +
                            '<td>' + ticket.updated + '</td>' +
                            '</tr>';
                    });

                    jiraHtml += '</tbody></table></div></div>';
                } else {
                    jiraHtml = '<div class="jira-section">' +
                        '<h3>Jira Tickets</h3>' +
                        '<p>No Jira tickets found matching your search criteria.</p>' +
                        '</div>';
                }
            }

            // Build GL Records HTML
            let glHtml = '';
            if (selectedSearchTypes.includes('gl')) {
                console.log('💰 Building GL HTML, records:', glRecords?.length || 0);
                
                if (glRecords && glRecords.length > 0) {
                    const totalAmount = glRecords.reduce((sum, record) => {
                        if (record.filterOptions) return sum;
                        const amount = parseFloat(record.amount) || 0;
                        return sum + Math.abs(amount);
                    }, 0);

                    // 收集所有唯一的attorney显示选项
                    const glClientOptions = [];
                    glRecords.forEach(record => {
                        if (record.filterOptions) return;
                        // 使用从服务器返回的已解密的client_name
                        const clientName = record.client_name || 'N/A';
                        const attorneyDisplay = getAttorneyDisplay(clientName);
                        if (!glClientOptions.includes(attorneyDisplay)) {
                            glClientOptions.push(attorneyDisplay);
                        }
                    });
                    glClientOptions.sort();

                    glHtml = '<div class="gl-section">' +
                        '<h3>GL Records</h3>' +
                        '<p style="margin-bottom: 15px; color: #6c757d;">Found ' + glRecords.length + ' GL record(s) (displaying first 200)</p>' +
                        
                        // GL过滤器
                        '<div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">' +
                        '<h4 style="margin-bottom: 15px; color: #495057;">GL Filters</h4>' +
                        '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px;">' +
                        '<div>' +
                        '<label style="font-size: 0.9em; font-weight: bold; color: #495057; display: block; margin-bottom: 5px;">Client:</label>' +
                        '<select id="glClientFilter" onchange="filterGLTable()" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9em; background-color: white;">' +
                        '<option value="">All Clients</option>';
                    
                    glClientOptions.forEach(option => {
                        glHtml += '<option value="' + option.replace(/"/g, '&quot;') + '">' + option + '</option>';
                    });
                    
                    glHtml += '</select>' +
                        '</div>' +
                        '<div>' +
                        '<label style="font-size: 0.9em; font-weight: bold; color: #495057; display: block; margin-bottom: 5px;">Vendor:</label>' +
                        '<select id="glVendorFilter" onchange="filterGLTable()" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9em; background-color: white;">' +
                        '<option value="">All Vendors</option>' +
                        '</select>' +
                        '</div>' +
                        '<div>' +
                        '<label style="font-size: 0.9em; font-weight: bold; color: #495057; display: block; margin-bottom: 5px;">Year:</label>' +
                        '<select id="glYearFilter" onchange="filterGLTable()" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9em; background-color: white;">' +
                        '<option value="">All Years</option>' +
                        '</select>' +
                        '</div>' +
                        '<div>' +
                        '<label style="font-size: 0.9em; font-weight: bold; color: #495057; display: block; margin-bottom: 5px;">Payment Type:</label>' +
                        '<select id="glParentFilter" onchange="filterGLTable()" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9em; background-color: white;">' +
                        '<option value="">All Payment Types</option>' +
                        '</select>' +
                        '</div>' +
                        '</div>' +
                        '<div style="margin-top: 12px;">' +
                        '<button onclick="clearGLFilters()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">Clear Filters</button>' +
                        '</div>' +
                        '</div>' +
                        
                        '<div style="overflow-x: auto;">' +
                        '<table class="gl-table" id="glTable">' +
                        '<thead><tr>' +
                        '<th class="col-gl-clname">Client</th>' +
                        '<th class="col-gl-vendor">Vendor</th>' +
                        '<th class="col-gl-amount">Total Amount</th>' +
                        '<th class="col-gl-parent">Payment Type</th>' +
                        '<th class="col-gl-year">Year</th>' +
                        '</tr>' +
                        '<tr id="glTotalRow" style="background: #fff3cd; font-weight: bold; border-bottom: 2px solid #6c757d;">' +
                        '<td class="col-gl-clname" style="text-align: center; color: #374151;"><strong>SPEND TOTAL</strong></td>' +
                        '<td class="col-gl-vendor" style="text-align: center; color: #856404;"></td>' +
                        '<td class="col-gl-amount" style="color: #374151; font-size: 1em;"><strong>$' + formatNumber(totalAmount) + '</strong></td>' +
                        '<td class="col-gl-parent" style="text-align: center; color: #856404;"></td>' +
                        '<td class="col-gl-year" style="text-align: center; color: #856404;"></td>' +
                        '</tr>' +
                        '</thead>' +
                        '<tbody id="glTableBody">';

                        // 添加数据行
                        glRecords.forEach((record, index) => {
                            if (record.filterOptions) return;

                            let amount = 'N/A';
                            if (record.amount && !isNaN(record.amount)) {
                                const absAmount = Math.abs(parseFloat(record.amount));
                                amount = '$' + formatNumber(absAmount); 
                            }
                            
                            const year = record.year || parseGLDate(record.date);
                            // 使用从服务器返回的已解密的client_name
                            const clientName = record.client_name || 'N/A';
                            const attorneyDisplay = getAttorneyDisplay(clientName);
                        
                        glHtml += '<tr class="gl-data-row" data-client="' + attorneyDisplay + '" ' +
                            'data-vendor="' + (record.assigned_vendor_name || '') + '" ' +
                            'data-year="' + year + '" ' +
                            'data-parent="' + (record.parent_company || '') + '" ' +
                            'data-amount="' + (record.amount || 0) + '">' +
                            '<td class="col-gl-clname"><strong>' + attorneyDisplay + '</strong></td>' +
                            '<td class="col-gl-vendor">' + (record.assigned_vendor_name || 'N/A') + '</td>' +
                            '<td class="col-gl-amount">' + amount + '</td>' +
                            '<td class="col-gl-parent">' + (record.parent_company || 'N/A') + '</td>' +
                            '<td class="col-gl-year">' + year + '</td>' +
                            '</tr>';
                    });

                    glHtml += '</tbody></table></div></div>';

                    // Store for filter initialization
                    window.originalGLRecords = glRecords.filter(record => !record.hasOwnProperty('filterOptions'));
                } else {
                    glHtml = '<div class="gl-section">' +
                        '<h3>GL Records</h3>' +
                        '<p>No GL records found matching your search criteria.</p>' +
                        '</div>';
                }
            }

            // Set the results HTML
            resultsDiv.innerHTML = summaryHtml + contractsHtml + jiraHtml + glHtml;

            // Initialize GL filters if needed
            if (selectedSearchTypes.includes('gl') && glRecords && glRecords.length > 0) {
                setTimeout(() => {
                    initializeGLFilters();
                }, 100);
            } else if (selectedSearchTypes.includes('contracts') && contracts && contracts.length > 0) {
                setTimeout(() => {
                }, 100);
            }
        }
        
        function filterContractTable() {
            console.log('🔍 Contract filter called');
            
            const clientFilter = document.getElementById('contractClientFilter');
            const vendorFilter = document.getElementById('contractVendorFilter');
            
            if (!clientFilter || !vendorFilter) {
                console.error('❌ Filter elements not found');
                return;
            }
            
            const clientValue = clientFilter.value;
            const vendorValue = vendorFilter.value;
            
            // 使用更精确的选择器
            const rows = document.querySelectorAll('#contractTable .contract-data-row');
            let visibleCount = 0;
            
            if (rows.length === 0) {
                console.warn('❌ No contract rows found');
                return;
            }
            
            rows.forEach(row => {
                const clientData = row.getAttribute('data-client');
                const vendorData = row.getAttribute('data-vendor') || '';
                
                const matchClient = !clientValue || clientData === clientValue;
                const matchVendor = !vendorValue || vendorData.toLowerCase() === vendorValue.toLowerCase();
                
                if (matchClient && matchVendor) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            console.log(`📄 Contract filter applied: ${visibleCount}/${rows.length} visible`);
            
            // 更新摘要信息
            const summaryElement = document.querySelector('.search-results-section p');
            if (summaryElement && visibleCount < rows.length) {
                summaryElement.innerHTML = `Found ${rows.length} contract(s)`;
            }
        }

        // 5. 新增Contract表格清除过滤器函数
        function clearContractFilters() {
            document.getElementById('contractClientFilter').value = '';
            document.getElementById('contractVendorFilter').value = ''; // NEW: Clear vendor filter
            filterContractTable();
        }

        function initializeGLFilters() {
            if (!window.originalGLRecords) return;
            
            const records = window.originalGLRecords;
            
            // FIXED: Case-insensitive vendor deduplication for GL
            const vendorSet = new Set();
            const yearSet = new Set();
            const parentSet = new Set();
            
            records.forEach(record => {
                // Vendors - case-insensitive deduplication
                if (record.assigned_vendor_name) {
                    const vendor = record.assigned_vendor_name.trim();
                    const lowerVendor = vendor.toLowerCase();
                    let found = false;
                    for (let existingVendor of vendorSet) {
                        if (existingVendor.toLowerCase() === lowerVendor) {
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        vendorSet.add(vendor);
                    }
                }
                
                // Years
                const year = record.year || parseGLDate(record.date);
                if (year) yearSet.add(year);
                
                // Parent companies - case-insensitive deduplication
                if (record.parent_company) {
                    const parent = record.parent_company.trim();
                    const lowerParent = parent.toLowerCase();
                    let found = false;
                    for (let existingParent of parentSet) {
                        if (existingParent.toLowerCase() === lowerParent) {
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        parentSet.add(parent);
                    }
                }
            });
            
            // Convert to arrays and sort
            const vendors = Array.from(vendorSet).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
            const years = Array.from(yearSet).sort();
            const parents = Array.from(parentSet).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
            
            populateFilterOptions('glVendorFilter', vendors);
            populateFilterOptions('glYearFilter', years);
            populateFilterOptions('glParentFilter', parents);
        }

        function populateFilterOptions(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // 保留第一个选项（All...）
            const firstOption = select.options[0];
            select.innerHTML = '';
            select.appendChild(firstOption);
            
            // 添加选项
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }

        function filterGLTable() {
            console.log('🔍 GL filter called');
            
            const clientFilter = document.getElementById('glClientFilter');
            const vendorFilter = document.getElementById('glVendorFilter');
            const yearFilter = document.getElementById('glYearFilter');
            const parentFilter = document.getElementById('glParentFilter');
            
            if (!clientFilter || !vendorFilter || !yearFilter || !parentFilter) {
                console.error('❌ GL Filter elements not found');
                return;
            }
            
            const clientValue = clientFilter.value;
            const vendorValue = vendorFilter.value;
            const yearValue = yearFilter.value;
            const parentValue = parentFilter.value;
            
            // 使用更精确的选择器
            const rows = document.querySelectorAll('#glTable .gl-data-row');
            let visibleCount = 0;
            let filteredTotal = 0;
            
            if (rows.length === 0) {
                console.warn('❌ No GL rows found');
                return;
            }
            
            rows.forEach(row => {
                const clientData = row.getAttribute('data-client');
                const vendor = row.getAttribute('data-vendor') || '';
                const year = row.getAttribute('data-year');
                const parent = row.getAttribute('data-parent') || '';
                const amount = parseFloat(row.getAttribute('data-amount')) || 0;
                
                const matchClient = !clientValue || clientData === clientValue;
                const matchVendor = !vendorValue || vendor.toLowerCase() === vendorValue.toLowerCase();
                const matchYear = !yearValue || year === yearValue;
                const matchParent = !parentValue || parent.toLowerCase() === parentValue.toLowerCase();
                
                if (matchClient && matchVendor && matchYear && matchParent) {
                    row.style.display = '';
                    visibleCount++;
                    filteredTotal += Math.abs(amount);
                } else {
                    row.style.display = 'none';
                }
            });
            
            // 更新总计行
            const totalRow = document.getElementById('glTotalRow');
            if (totalRow) {
                const totalCell = totalRow.querySelector('.col-gl-amount strong');
                if (totalCell) {
                    totalCell.textContent = '$' + formatNumber(filteredTotal);
                }
                
                const countCell = totalRow.querySelector('.col-gl-clname strong');
                if (countCell) {
                    countCell.textContent = `SPEND TOTAL (${visibleCount} records)`;
                }
            }
            
            console.log(`💰 GL filter applied: ${visibleCount}/${rows.length} visible`);
        }

        function clearGLFilters() {
            document.getElementById('glClientFilter').value = '';
            document.getElementById('glVendorFilter').value = '';
            document.getElementById('glYearFilter').value = '';
            document.getElementById('glParentFilter').value = '';
            filterGLTable();
        }

        function resetCoopMapping() {
            coopMapping = {};
            coopCounter = 1;
            isCoopMappingInitialized = false;
            console.log('🔄 Corp mapping reset');
        }

        function getStatusBadgeClass(status) {
            switch (status.toLowerCase()) {
                case 'done':
                    return 'status-badge done';
                case 'to do':
                    return 'status-badge todo';
                case 'work in progress':
                    return 'status-badge work-in-progress';
                case 'infosec review':
                    return 'status-badge infosec-review';
                case 'in legal review':
                    return 'status-badge legal-review';
                case 'rfp/rfq/negotiations':
                    return 'status-badge negotiations';
                case 'added to database':
                    return 'status-badge database';
                case 'future project':
                    return 'status-badge future-project';
                case 'w/ procurement':
                    return 'status-badge procurement';
                case 'data collection':
                    return 'status-badge collection';
                case 'w/ stakeholder':
                    return 'status-badge stakeholder';
                case 'out for signature':
                    return 'status-badge signature';
                case 'w/ vendor':
                    return 'status-badge vendor';
                case 'open':
                    return 'status-badge open'
                default:
                    return 'status-badge default';
            }
        }

        function getPriorityBadgeClass(priority) {
            switch (priority.toLowerCase()) {
                case 'high':
                    return 'priority-badge high';
                case 'medium':
                    return 'priority-badge medium';
                case 'low':
                    return 'priority-badge low';
                default:
                    return 'priority-badge medium';
            }
        }

        let mainFiltersLoaded = false;

        async function loadMainFilterOptions() {
            if (mainFiltersLoaded) {
                console.log('📋 Main filters already loaded, skipping...');
                return;
            }
            
            try {
                const response = await fetch('/api/contracts?limit=200');
                if (response.ok) {
                    const data = await response.json();
                    const contracts = data.contracts || [];
                    
                    // Populate contract types
                    const types = [...new Set(contracts.map(c => c.contract_type).filter(Boolean))];
                    const typeSelect = document.getElementById('mainFilterType');
                    if (typeSelect) {
                        // Clear existing options except the first one
                        typeSelect.innerHTML = '<option value="">All Types</option>';
                        types.forEach(type => {
                            const option = document.createElement('option');
                            option.value = type;
                            option.textContent = type;
                            typeSelect.appendChild(option);
                        });
                    }
                    
                    mainFiltersLoaded = true;
                    console.log('📋 Main filters loaded successfully');
                }
            } catch (error) {
                console.warn('Could not load main filter options:', error);
            }
        }

        function clearMainFilters() {
            document.getElementById('mainSearchInput').value = '';
            document.getElementById('mainFilterType').value = '';
            document.getElementById('mainFilterStatus').value = '';
            document.getElementById('mainFilterTicketStatus').value = '';
            
            // Clear vendor selections
            clearSelectedVendors();
            
            // Clear date filters
            document.getElementById('contractStartDateFrom').value = '';
            document.getElementById('contractStartDateTo').value = '';
            document.getElementById('contractEndDateFrom').value = '';
            document.getElementById('contractEndDateTo').value = '';
            
            document.getElementById('mainResults').innerHTML = '';
            
            // Reset search type checkboxes
            document.querySelector('input[name="searchType"][value="contracts"]').checked = true;
            document.querySelector('input[name="searchType"][value="jira"]').checked = true;
            document.querySelector('input[name="searchType"][value="gl"]').checked = true;
        }

        function selectOption(type) {
            comparisonType = type;
            
            document.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.option-card').classList.add('selected');
            
            const standardSection = document.getElementById('standardTemplateSection');
            if (type === 'standard') {
                standardSection.style.display = 'block';
            } else {
                standardSection.style.display = 'none';
                standardFile = null;
                document.getElementById('standardFileInfo').style.display = 'none';
            }
            
            checkAnalysisReady();
        }

        function checkAnalysisReady() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            const hasFile = selectedFile !== null;
            const hasComparisonType = comparisonType !== null;
            
            let hasRequiredData = false;
            
            if (comparisonType === 'database') {
                hasRequiredData = true; // Database comparison doesn't need additional files
            } else if (comparisonType === 'standard') {
                hasRequiredData = standardFile !== null; // Standard comparison needs template file
            }
            
            analyzeBtn.disabled = !(hasFile && hasComparisonType && hasRequiredData);
        }

        async function testJiraConnection() {
                    try {
                        const response = await fetch('/api/jira/test-connection', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();
                        
                        if (data.success) {
                            document.getElementById('jiraStatus').style.display = 'block';
                            document.getElementById('jiraStatus').textContent = `${data.message} (User: ${data.user || 'Connected'})`;
                            hideError();
                        } else {
                            showError(data.message);
                            document.getElementById('jiraStatus').style.display = 'none';
                        }
                    } catch (error) {
                        showError('Failed to test Jira connection: ' + error.message);
                        document.getElementById('jiraStatus').style.display = 'none';
                    }
                }

                async function testConnection() {
                    try {
                        const response = await fetch('/api/test-db-connection', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();
                        
                        if (data.success) {
                            document.getElementById('dbStatus').style.display = 'block';
                            document.getElementById('dbStatus').textContent = data.message;
                            hideError();
                        } else {
                            showError(data.message);
                            document.getElementById('dbStatus').style.display = 'none';
                        }
                    } catch (error) {
                        showError('Failed to test database connection: ' + error.message);
                        document.getElementById('dbStatus').style.display = 'none';
                    }
                }
        

        async function analyzeContract() {
            if (!selectedFile) {
                showError('Please select a contract file first.');
                return;
            }

            showLoading(true, 'Analyzing contract with AI...');
            hideError();

            try {
                const formData = new FormData();
                formData.append('contract', selectedFile);
                formData.append('comparisonType', comparisonType);
                
                if (comparisonType === 'standard' && standardFile) {
                    formData.append('standard', standardFile);
                }

                console.log('Starting contract analysis...');
                
                const response = await fetch('/api/analyze-contract', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'HTTP error! status: ' + response.status);
                }

                const result = await response.json();
                
                if (result.success) {
                    console.log('✅ Analysis completed successfully');
                    displayAnalysisResults(result.analysis, result.similarContracts || []);
                } else {
                    throw new Error(result.error || 'Analysis failed');
                }

            } catch (error) {
                console.error('❌ Analysis failed:', error);
                showError('Analysis failed: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayAnalysisResults(analysis, similarContracts) {
            const resultsDiv = document.getElementById('results');
            
            const jsonMatch = analysis.match(/```json\n([\s\S]*?)\n```/);
            let contractSummary = null;
            let analysisText = analysis;
            
            if (jsonMatch) {
                try {
                    contractSummary = JSON.parse(jsonMatch[1]);
                    analysisText = analysis.replace(/```json\n[\s\S]*?\n```/, '').trim();
                } catch (e) {
                    console.warn('Could not parse JSON summary');
                }
            }

            let summaryHtml = '';
            if (contractSummary) {
                summaryHtml = '<div style="background: #ffffff; border-left: 4px solid #2196f3; padding: 20px; margin-bottom: 20px; border-radius: 5px;">' +
                    '<h4>Contract Summary</h4>' +
                    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">' +
                    '<div><strong>Contract Type:</strong> ' + (contractSummary.contract_type || 'Not specified') + '</div>' +
                    '<div><strong>Vendor:</strong> ' + (contractSummary.vendor_name || 'Not specified') + '</div>' +
                    '<div><strong>Risk Level:</strong> ' +
                    '<span style="padding: 4px 8px; border-radius: 12px; font-size: 0.8em; color: white; background: ' +
                    (contractSummary.risk_level === 'high' ? '#f44336' : 
                    contractSummary.risk_level === 'medium' ? '#ff9800' : '#4caf50') + ';">' +
                    (contractSummary.risk_level || 'medium').toUpperCase() +
                    '</span></div>' +
                    '<div><strong>Estimated Value:</strong> ' + (contractSummary.estimated_value || 'Not specified') + '</div>' +
                    '<div><strong>Currency:</strong> ' + (contractSummary.currency || 'Not specified') + '</div>' +
                    '<div><strong>Legal Review Required:</strong> ' +
                    '<span style="color: ' + (contractSummary.requires_legal_review ? '#f44336' : '#4caf50') + ';">' +
                    (contractSummary.requires_legal_review ? 'YES' : 'NO') + '</span></div>' +
                    '</div>';
                
                // Enhanced YOY Increases Section
                if (contractSummary.yoy_increases) {
                    summaryHtml += '<div style="margin-top: 15px; padding: 15px; background: #F1F5F9; border-left: 4px solid #ff9800; border-radius: 5px;">' +
                        '<h5 style="margin-bottom: 10px; color: #e65100;">Year-over-Year Increases Analysis</h5>';
                    
                    if (contractSummary.yoy_increases.found) {
                        summaryHtml += '<div style="margin-bottom: 8px;"><strong>Found:</strong> <span style="color: #4caf50;">Yes</span></div>';
                        if (contractSummary.yoy_increases.percentage) {
                            summaryHtml += '<div style="margin-bottom: 8px;"><strong>Current Percentage:</strong> ' + contractSummary.yoy_increases.percentage + '</div>';
                        }
                        if (contractSummary.yoy_increases.clause_description) {
                            summaryHtml += '<div style="margin-bottom: 8px;"><strong>Clause Details:</strong> ' + contractSummary.yoy_increases.clause_description + '</div>';
                        }
                        summaryHtml += '<div style="margin-bottom: 8px;"><strong>Industry Standard:</strong> ' + (contractSummary.yoy_increases.industry_standard || 'Not specified') + '</div>';
                        summaryHtml += '<div><strong>Recommendation:</strong> ' + (contractSummary.yoy_increases.recommendation || 'No specific recommendation') + '</div>';
                    } else {
                        summaryHtml += '<div style="margin-bottom: 8px;"><strong>Found:</strong> <span style="color: #f44336;">No YOY increases detected</span></div>';
                        summaryHtml += '<div style="margin-bottom: 8px;"><strong>Industry Standard:</strong> ' + (contractSummary.yoy_increases.industry_standard || 'Typically 2-5% annually') + '</div>';
                        summaryHtml += '<div><strong>Recommendation:</strong> ' + (contractSummary.yoy_increases.recommendation || 'Consider adding reasonable annual escalation clause') + '</div>';
                    }
                    summaryHtml += '</div>';
                }

                // Enhanced Pricing Issues Section
                if (contractSummary.incomplete_pricing_sections && contractSummary.incomplete_pricing_sections.length > 0) {
                    summaryHtml += '<div style="margin-top: 15px; padding: 15px; background: #F1F5F9; border-left: 4px solid #f44336; border-radius: 5px;">' +
                        '<h5 style="margin-bottom: 10px; color: #c62828;">Incomplete Pricing Sections</h5>' +
                        '<p style="margin-bottom: 10px; color: #d32f2f;">The following sections mention products/services but lack clear pricing:</p>' +
                        '<ul style="margin-bottom: 0; color: #d32f2f;">';
                    contractSummary.incomplete_pricing_sections.forEach(section => {
                        summaryHtml += '<li>' + section + '</li>';
                    });
                    summaryHtml += '</ul></div>';
                }

                // Pricing Issues
                if (contractSummary.pricing_issues && contractSummary.pricing_issues.length > 0) {
                    summaryHtml += '<div style="margin-top: 15px; padding: 15px; background: #F1F5F9; border-left: 4px solid #ff9800; border-radius: 5px;">' +
                        '<h5 style="margin-bottom: 10px; color: #e65100;">Pricing Concerns</h5>' +
                        '<ul style="margin-bottom: 0;">';
                    contractSummary.pricing_issues.forEach(issue => {
                        summaryHtml += '<li>' + issue + '</li>';
                    });
                    summaryHtml += '</ul></div>';
                }
                
                if (contractSummary.key_terms && contractSummary.key_terms.length > 0) {
                    summaryHtml += '<div style="margin-top: 15px;"><strong>Key Terms:</strong><ul style="margin-top: 5px;">';
                    contractSummary.key_terms.forEach(term => {
                        summaryHtml += '<li>' + term + '</li>';
                    });
                    summaryHtml += '</ul></div>';
                }
                
                summaryHtml += '</div>';
            }

            // Similar contracts section (only for database comparison)
            let similarContractsHtml = '';
            if (similarContracts && similarContracts.length > 0) {
                similarContractsHtml = '<div style="background: #f8f9fa; border-left: 4px solid #374151; padding: 20px; margin: 20px 0; border-radius: 5px;">' +
                    '<h4>Similar Contracts Found (Same Vendor)</h4>' +
                    '<p style="margin-bottom: 15px; color: #6c757d;">Found ' + similarContracts.length + ' contract(s) with the same vendor in our database:</p>' +
                    '<div style="overflow-x: auto; margin-top: 15px;">' +
                    '<table class="contracts-table">' +
                    '<thead><tr>' +
                    '<th class="col-contract-id">Contract ID</th>' +
                    '<th class="col-client">Client</th>' +
                    '<th class="col-contract-name">Contract Name</th>' +
                    '<th class="col-vendor">Vendor</th>' +
                    '<th class="col-spend">Spend</th>' +
                    '<th class="col-file">Actions</th>' +
                    '</tr></thead><tbody>';
                
                similarContracts.sort((a, b) => {
                    const spendA = parseFloat(a.spend) || 0;
                    const spendB = parseFloat(b.spend) || 0;
                    return spendB - spendA;
                });

                similarContracts.forEach(contract => {
                    const clnumKey = parseInt(contract.clnum);
                    const clientName = clientMapping[clnumKey] || contract.clientName || `Client ${contract.clnum || 'Unknown'}`;
                    const attorneyDisplay = getAttorneyDisplay(clientName);
                    
                    const spendDisplay = contract.spend ? 
                        (contract.currency ? contract.currency + formatNumber(contract.spend) : '$' + formatNumber(contract.spend)) : 'N/A';
                        
                    similarContractsHtml += '<tr>' +
                        '<td class="col-contract-id">' + (contract.contractId || 'N/A') + '</td>' +
                        '<td class="col-client"><strong>' + attorneyDisplay + '</strong></td>' +
                        '<td class="col-contract-name">' + (contract.contractName || 'N/A') + '</td>' +
                        '<td class="col-vendor">' + (contract.vendor || 'N/A') + '</td>' +
                        '<td class="col-spend">' + spendDisplay + '</td>' +
                        '<td class="col-file">' + 
                        (contract.file ? 
                            '<button onclick="previewFile(\'' + contract.file + '\')" style="background: #1e3a8a; color: white; border: none; padding: 3px 6px; border-radius: 4px; cursor: pointer; font-size: 0.75em; margin-bottom: 3px; width: 100%;">Preview</button><br>' +
                            '<button onclick="downloadFile(\'' + contract.file + '\', \'' + (contract.contractName || 'contract') + '\')" style="background: #3b82f6; color: white; border: none; padding: 3px 6px; border-radius: 4px; cursor: pointer; font-size: 0.75em; margin-bottom: 3px; width: 100%;">Download</button><br>' +
                            '<button onclick="compareWithNew(\'' + contract.file + '\', \'' + (contract.contractName || 'New Contract').replace(/'/g, '\\\'') + '\')" style="background: #fbbf24; color: #1f2937; border: none; padding: 3px 6px; border-radius: 4px; cursor: pointer; font-size: 0.75em; width: 100%;">Compare</button>'
                            : '<span style="color: #6c757d; font-size: 0.8em;">No file</span>'
                        ) +
                        '</td></tr>';
                });
                
                similarContractsHtml += '</tbody></table></div></div>';
            }

            const formattedAnalysisText = analysisText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                                    .replace(/\* /g, '• ')
                                                    .replace(/\n/g, '<br>');

            const exportButtonHtml = `
                <div style="text-align: right; margin-bottom: 20px;">
                    <button onclick="exportContractAnalysis()" 
                            style="background: #1e40af; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                        Export Report
                    </button>
                </div>
            `;

            // 设置分析数据用于导出
            analysisExporter.setAnalysisData({
                contractSummary: contractSummary,
                detailedAnalysis: analysisText,
                similarContracts: similarContracts
            }, 'contract_analysis');

            resultsDiv.innerHTML = '<div class="results">' +
                '<h3>Contract Analysis Results</h3>' +
                exportButtonHtml +
                summaryHtml +
                similarContractsHtml +
                '<div style="background: white; border-left: 4px solid #6c757d; padding: 20px; margin: 20px 0; border-radius: 5px;">' +
                '<h4>Detailed Analysis</h4>' +
                '<div style="white-space: pre-wrap; line-height: 1.6; font-size: 1em; margin-top: 15px;">' +
                formattedAnalysisText +
                '</div></div></div>';
        }

        // Helper functions
        function formatDateFromNumber(dateNumber) {
            if (!dateNumber) return 'N/A';
            const dateStr = dateNumber.toString();
            if (dateStr.length === 8) {
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                return `${year}-${month}-${day}`;
            }
            return dateNumber;
        }

        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) {
                return 'N/A';
            }
            
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }

        function showLoading(show, text = 'Processing...') {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('loadingText').textContent = text;
        }

        function showMainLoading(show, text = 'Processing...') {
            document.getElementById('mainLoading').style.display = show ? 'block' : 'none';
            document.getElementById('mainLoadingText').textContent = text;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function showMainError(message) {
            const errorDiv = document.getElementById('mainErrorMsg');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMsg').style.display = 'none';
        }

        function hideMainError() {
            document.getElementById('mainErrorMsg').style.display = 'none';
        }

        // Function to preview files from S3
        async function previewFile(fileUrl) {
            try {
                showLoading(true, 'Loading file preview...');
                
                const response = await fetch('/api/preview-file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fileUrl: fileUrl
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to preview file');
                }

                const blob = await response.blob();
                const previewUrl = window.URL.createObjectURL(blob);
                
                const previewWindow = window.open(previewUrl, '_blank');
                if (!previewWindow) {
                    throw new Error('Popup blocked. Please allow popups for this site.');
                }
                
                setTimeout(() => {
                    window.URL.revokeObjectURL(previewUrl);
                }, 5000);

                console.log('👁️ File preview opened successfully');

            } catch (error) {
                console.error('Preview failed:', error);
                showError('Failed to preview file: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Function to download files from S3
        async function downloadFile(fileUrl, fileName) {
            try {
                showLoading(true, 'Downloading file...');
                
                const response = await fetch('/api/download-file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fileUrl: fileUrl,
                        fileName: fileName
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to download file');
                }

                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = downloadUrl;
                
                const extension = fileUrl.split('.').pop();
                link.download = fileName.replace(/[^a-z0-9.\-_]/gi, '_') + '.' + extension;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(downloadUrl);

                console.log('✅ File downloaded successfully');

            } catch (error) {
                console.error('Download failed:', error);
                showError('Failed to download file: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Create Jira Ticket Modal Functions
        function openCreateTicketModal() {
            document.getElementById('createTicketModal').style.display = 'block';
            document.getElementById('ticketSummary').focus();
            // Clear previous state
            document.getElementById('ticketError').style.display = 'none';
            document.getElementById('ticketSuccess').style.display = 'none';
            document.getElementById('ticketLoading').style.display = 'none';
        }

        function closeCreateTicketModal() {
            document.getElementById('createTicketModal').style.display = 'none';
            // Clear form
            document.getElementById('ticketSummary').value = '';
            document.getElementById('ticketDescription').value = '';
            document.getElementById('ticketPriority').value = 'Medium';
            document.getElementById('ticketType').value = 'Task';
            document.getElementById('ticketProject').value = 'REQUEST';
        }

        async function createJiraTicket() {
            const summary = document.getElementById('ticketSummary').value.trim();
            const description = document.getElementById('ticketDescription').value.trim();
            const priority = document.getElementById('ticketPriority').value;
            const issueType = document.getElementById('ticketType').value;
            const projectKey = document.getElementById('ticketProject').value;

            if (!summary) {
                showTicketError('Summary is required');
                return;
            }

            try {
                showTicketLoading(true);
                hideTicketError();
                hideTicketSuccess();

                const response = await fetch('/api/jira/create-ticket', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        summary: summary,
                        description: description || 'Created from Contract Analysis System',
                        priority: priority,
                        issueType: issueType,
                        projectKey: projectKey
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showTicketSuccess(`Ticket ${data.ticketId} created successfully!<br>
                        <a href="${data.ticketUrl}" target="_blank" style="color: #007bff; text-decoration: underline;">
                            View ticket in Jira →
                        </a>`);
                    
                    // Clear form after successful creation
                    setTimeout(() => {
                        closeCreateTicketModal();
                    }, 3000);
                } else {
                    throw new Error(data.error || 'Failed to create ticket');
                }

            } catch (error) {
                console.error('Failed to create Jira ticket:', error);
                showTicketError('Failed to create Jira ticket: ' + error.message);
            } finally {
                showTicketLoading(false);
            }
        }

        function showTicketLoading(show) {
            document.getElementById('ticketLoading').style.display = show ? 'block' : 'none';
        }

        function showTicketError(message) {
            const errorDiv = document.getElementById('ticketError');
            errorDiv.innerHTML = message;
            errorDiv.style.display = 'block';
        }

        function hideTicketError() {
            document.getElementById('ticketError').style.display = 'none';
        }

        function showTicketSuccess(message) {
            const successDiv = document.getElementById('ticketSuccess');
            successDiv.innerHTML = message;
            successDiv.style.display = 'block';
        }

        function hideTicketSuccess() {
            document.getElementById('ticketSuccess').style.display = 'none';
        }

        document.addEventListener('click', function(event) {
            // Handle modal closing
            const createTicketModal = document.getElementById('createTicketModal');
            if (event.target === createTicketModal) {
                closeCreateTicketModal();
            }
            
            const comparisonModal = document.getElementById('contractComparisonModal');
            if (event.target === comparisonModal) {
                closeComparisonModal();
            }
            
            // Handle vendor suggestions hiding
            const vendorInput = document.getElementById('mainSearchInput');
            const vendorSuggestions = document.getElementById('vendorSuggestions');
            
            if (vendorInput && vendorSuggestions && 
                !vendorInput.contains(event.target) && 
                !vendorSuggestions.contains(event.target)) {
                vendorSuggestions.style.display = 'none';
            }
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                // Close any open modals
                const createTicketModal = document.getElementById('createTicketModal');
                if (createTicketModal.style.display === 'block') {
                    closeCreateTicketModal();
                }
                
                const comparisonModal = document.getElementById('contractComparisonModal');
                if (comparisonModal.style.display === 'block') {
                    closeComparisonModal();
                }
            }
        });

        let selectedReferenceContract = null;
        let newContractForComparison = null;

        // 修改比较逻辑 - 区分第一个tab和第二个tab的行为
        function compareWithNew(fileUrl, contractName) {
            console.log('📋 Starting contract comparison with:', { fileUrl, contractName });
            
            // 检查当前是否在第一个tab且有已上传的合同
            const currentTab = document.querySelector('.tab-content.active').id;
            
            if (currentTab === 'contract-analysis' && selectedFile) {
                // 第一个tab：直接使用已上传的合同进行比较
                console.log('📋 First tab: Using uploaded contract for direct comparison');
                performDirectComparison(fileUrl, contractName);
            } else {
                // 第二个tab：显示上传模态框让用户上传新合同
                console.log('📋 Second tab: Opening modal for new contract upload');
                openComparisonModal(fileUrl, contractName);
            }
        }

        // Close comparison modal
        function closeComparisonModal() {
            document.getElementById('contractComparisonModal').style.display = 'none';
            selectedReferenceContract = null;
            newContractForComparison = null;
        }

        // Handle new contract upload for comparison
        function handleNewContractUpload(input) {
            const file = input.files?.[0];
            if (file) {
                newContractForComparison = file;
                console.log('📋 New contract uploaded:', file.name, file.type, file.size);
                
                const fileInfo = document.getElementById('newContractInfo');
                fileInfo.innerHTML = 
                    '<strong>Selected:</strong> ' + file.name + '<br>' +
                    '<strong>Size:</strong> ' + (file.size / 1024 / 1024).toFixed(2) + ' MB';
                fileInfo.style.display = 'block';
                
                document.getElementById('startComparisonBtn').disabled = false;
                console.log('📋 Comparison button enabled');
            }
        }

        // Start contract comparison
        async function startContractComparison() {
            if (!selectedReferenceContract || !newContractForComparison) {
                showComparisonError('Please select both contracts');
                return;
            }

            console.log('📋 Starting comparison:', {
                reference: selectedReferenceContract,
                newContract: newContractForComparison.name
            });

            try {
                showComparisonLoading(true);
                hideComparisonError();

                const formData = new FormData();
                formData.append('newContract', newContractForComparison);
                formData.append('referenceContractUrl', selectedReferenceContract.url);
                formData.append('referenceContractName', selectedReferenceContract.name);

                console.log('📋 Sending request to /api/compare-contracts...');

                const response = await fetch('/api/compare-contracts', {
                    method: 'POST',
                    body: formData
                });

                console.log('📋 Response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('📋 API Error:', errorData);
                    throw new Error(errorData.error || 'Comparison failed');
                }

                const result = await response.json();
                console.log('📋 Comparison result:', result);
                
                if (result.success) {
                    console.log('✅ Comparison successful, displaying results...');
                    displayComparisonResults(result.analysis);
                } else {
                    throw new Error(result.error || 'Comparison failed');
                }

            } catch (error) {
                console.error('❌ Comparison failed:', error);
                showComparisonError('Comparison failed: ' + error.message);
            } finally {
                showComparisonLoading(false);
            }
        }

        function displayComparisonResults(analysis) {
            const resultsDiv = document.getElementById('comparisonResults');
            resultsDiv.innerHTML = '';
            resultsDiv.style.display = 'block';

            console.log('📋 Raw analysis received:', analysis);

            // 尝试多种方式提取JSON
            let jsonData = null;
            let rawText = analysis;

            // 方法1: 查找JSON代码块
            const codeBlockRegex = /```json\s*([\s\S]*?)\s*```/;
            const codeBlockMatch = analysis.match(codeBlockRegex);
            
            if (codeBlockMatch) {
                try {
                    jsonData = JSON.parse(codeBlockMatch[1].trim());
                    console.log('📋 Successfully parsed JSON from code block');
                } catch (e) {
                    console.warn('📋 Failed to parse JSON from code block:', e.message);
                }
            }

            // 方法2: 查找花括号包围的JSON
            if (!jsonData) {
                const jsonRegex = /\{[\s\S]*\}/;
                const jsonMatch = analysis.match(jsonRegex);
                
                if (jsonMatch) {
                    try {
                        jsonData = JSON.parse(jsonMatch[0]);
                        console.log('📋 Successfully parsed JSON from text');
                    } catch (e) {
                        console.warn('📋 Failed to parse JSON from text:', e.message);
                    }
                }
            }

            // 方法3: 尝试清理和解析整个文本
            if (!jsonData) {
                try {
                    // 移除所有markdown格式和额外文本
                    let cleanedText = analysis
                        .replace(/```json/g, '')
                        .replace(/```/g, '')
                        .replace(/^\s*Format the analysis[\s\S]*$/m, '')
                        .trim();
                    
                    // 找到第一个 { 和最后一个 }
                    const firstBrace = cleanedText.indexOf('{');
                    const lastBrace = cleanedText.lastIndexOf('}');
                    
                    if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
                        const jsonString = cleanedText.slice(firstBrace, lastBrace + 1);
                        jsonData = JSON.parse(jsonString);
                        console.log('📋 Successfully parsed cleaned JSON');
                    }
                } catch (e) {
                    console.warn('📋 Failed to parse cleaned JSON:', e.message);
                }
            }

            // 如果还是没有JSON数据，显示格式化的原始文本
            if (!jsonData) {
                console.log('📋 No valid JSON found, displaying formatted text');
                
                resultsDiv.innerHTML = `
                    <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #856404; margin-bottom: 10px;">Can't parse JSON format</h4>
                        <p style="color: #856404; margin-bottom: 10px;">Result:</p>
                        <details style="margin-top: 10px;">
                            <summary style="color: #856404; cursor: pointer;">Check original data</summary>
                            <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 0.8em; margin-top: 10px; white-space: pre-wrap;">${analysis}</pre>
                        </details>
                    </div>
                    <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; line-height: 1.6;">
                        ${analysis.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}
                    </div>
                `;
                return;
            }

            // 成功解析JSON，创建比较界面
            console.log('📋 Parsed JSON data:', jsonData);
            
            // 创建主容器
            const mainContainer = document.createElement('div');
            mainContainer.style.cssText = `
                background: #f8f9fa;
                border-radius: 8px;
                padding: 16px;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            `;

            // 添加标题
            const titleDiv = document.createElement('div');
            titleDiv.innerHTML = `
                <h3 style="color: #2c3e50; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #dee2e6; font-size: 1.3em;">
                    Contract Comparison Analysis
                </h3>
            `;
            mainContainer.appendChild(titleDiv);

            // 渲染每个主要部分
            Object.entries(jsonData).forEach(([sectionKey, sectionData]) => {
                if (typeof sectionData === 'object' && sectionData !== null) {
                    const sectionDiv = createSection(sectionKey, sectionData, 0);
                    mainContainer.appendChild(sectionDiv);
                }
            });

            resultsDiv.appendChild(mainContainer);

            // 创建章节的递归函数
            function createSection(sectionKey, sectionData, level) {
                const sectionDiv = document.createElement('div');
                sectionDiv.style.cssText = `
                    margin-bottom: ${level === 0 ? '16px' : '12px'};
                    padding: ${level === 0 ? '16px' : '12px'};
                    background: ${level === 0 ? '#ffffff' : '#f1f3f4'};
                    border-radius: 6px;
                    border-left: 3px solid ${level === 0 ? '#6c757d' : '#adb5bd'};
                    box-shadow: ${level === 0 ? '0 1px 3px rgba(0,0,0,0.06)' : 'none'};
                `;

                // 创建章节标题
                const titleDiv = document.createElement('div');
                titleDiv.innerHTML = `
                    <h${Math.min(4 + level, 6)} style="
                        color: #495057; 
                        margin-bottom: 10px; 
                        font-size: ${1.1 - level * 0.08}em;
                        font-weight: 600;
                    ">
                        ${formatSectionTitle(sectionKey)}
                    </h${Math.min(4 + level, 6)}>
                `;
                sectionDiv.appendChild(titleDiv);

                // 检查是否是对比节点
                if (hasComparisonStructure(sectionData)) {
                    const comparisonTable = createComparisonTable(sectionData);
                    sectionDiv.appendChild(comparisonTable);
                } else if (typeof sectionData === 'object' && !Array.isArray(sectionData)) {
                    // 递归处理子章节
                    Object.entries(sectionData).forEach(([key, value]) => {
                        if (typeof value === 'object' && value !== null) {
                            const subSection = createSection(key, value, level + 1);
                            sectionDiv.appendChild(subSection);
                        } else {
                            // 显示简单的键值对
                            const valueDiv = document.createElement('div');
                            valueDiv.style.cssText = `
                                background: #e9ecef;
                                padding: 8px 10px;
                                border-radius: 3px;
                                color: #495057;
                                margin: 4px 0;
                                font-size: 0.85em;
                                line-height: 1.3;
                            `;
                            valueDiv.innerHTML = `<strong>${formatSectionTitle(key)}:</strong> ${value || '—'}`;
                            sectionDiv.appendChild(valueDiv);
                        }
                    });
                } else {
                    // 显示普通值
                    const valueDiv = document.createElement('div');
                    valueDiv.style.cssText = `
                        background: #e9ecef;
                        padding: 8px 10px;
                        border-radius: 3px;
                        color: #495057;
                        font-size: 0.85em;
                        margin-top: 4px;
                        line-height: 1.3;
                    `;
                    valueDiv.textContent = sectionData?.toString() || '—';
                    sectionDiv.appendChild(valueDiv);
                }

                return sectionDiv;
            }

            // 检查是否有Reference_Contract和New_Contract结构
            function hasComparisonStructure(data) {
                if (typeof data !== 'object' || data === null) return false;
                return data.hasOwnProperty('Reference_Contract') || data.hasOwnProperty('New_Contract');
            }

            // 创建对比表格
            function createComparisonTable(data) {
                const table = document.createElement('div');
                table.style.cssText = `
                    display: grid;
                    grid-template-columns: 1fr 1fr 1fr;
                    gap: 1px;
                    background: #dee2e6;
                    border-radius: 4px;
                    overflow: hidden;
                    margin-top: 6px;
                `;

                // 表头
                ['Summary', 'Reference Contract', 'New Contract'].forEach(header => {
                    const headerCell = document.createElement('div');
                    headerCell.style.cssText = `
                        background: #6c757d;
                        color: white;
                        padding: 8px 10px;
                        font-weight: 600;
                        font-size: 0.85em;
                        text-align: center;
                    `;
                    headerCell.textContent = header;
                    table.appendChild(headerCell);
                });

                // 如果有直接的Reference_Contract和New_Contract
                if (data.Reference_Contract || data.New_Contract) {
                    const refData = data.Reference_Contract || {};
                    const newData = data.New_Contract || {};
                    
                    if (typeof refData === 'object' && typeof newData === 'object') {
                        // 对象类型 - 显示子字段
                        const allFields = new Set([...Object.keys(refData), ...Object.keys(newData)]);
                        
                        allFields.forEach(field => {
                            addComparisonRow(table, field, refData[field], newData[field]);
                        });
                    } else {
                        // 简单值 - 直接比较
                        addComparisonRow(table, 'Content', refData, newData);
                    }
                } else {
                    // 查找其他可能的对比字段
                    Object.entries(data).forEach(([key, value]) => {
                        if (typeof value === 'object' && value !== null) {
                            if (value.Reference_Contract || value.New_Contract) {
                                addComparisonRow(table, key, value.Reference_Contract, value.New_Contract);
                            }
                        }
                    });
                }

                return table;
            }

            // 添加对比行
            function addComparisonRow(table, fieldName, refValue, newValue) {
                // 字段名称
                const fieldCell = document.createElement('div');
                fieldCell.style.cssText = `
                    background: #e9ecef;
                    padding: 8px 10px;
                    font-weight: 500;
                    color: #495057;
                    border-right: 1px solid #dee2e6;
                    font-size: 0.85em;
                `;
                fieldCell.textContent = formatSectionTitle(fieldName);
                table.appendChild(fieldCell);

                // 处理和格式化值
                const refText = formatCellValue(refValue);
                const newText = formatCellValue(newValue);

                // 参考合同值
                const refCell = document.createElement('div');
                refCell.style.cssText = `
                    background: #f8f9fa;
                    padding: 8px 10px;
                    color: #6c757d;
                    border-right: 1px solid #dee2e6;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    font-size: 0.85em;
                    word-wrap: break-word;
                    line-height: 1.3;
                `;
                refCell.textContent = refText;
                table.appendChild(refCell);

                // 新合同值 - 检查差异
                const newCell = document.createElement('div');
                const isDifferent = refText !== newText && newText !== '—' && refText !== '—';
                
                newCell.style.cssText = `
                    background: ${isDifferent ? '#E9ECEF' : '#E9ECEF'};
                    color: ${isDifferent ? '#6c757d' : '#6c757d'};
                    padding: 8px 10px;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    font-size: 0.85em;
                    font-weight: ${isDifferent ? '600' : 'normal'};
                    word-wrap: break-word;
                    line-height: 1.3;
                    position: relative;
                `;
                
                if (isDifferent) {
                    newCell.style.borderLeft = '3px solid white';
                }
                
                newCell.textContent = newText;
                table.appendChild(newCell);
            }

            // 格式化单元格值
            function formatCellValue(value) {
                if (value === null || value === undefined) return '—';
                if (Array.isArray(value)) {
                    // 检查是否是被错误拆分的字符数组
                    if (value.length > 0 && value.every(item => typeof item === 'string' && item.length <= 1)) {
                        return value.join('');
                    }
                    return value.join(', ');
                }
                if (typeof value === 'object') {
                    return JSON.stringify(value, null, 2);
                }
                return value.toString();
            }

            // 格式化章节标题
            function formatSectionTitle(title) {
                return title
                    .replace(/_/g, ' ')
                    .replace(/([a-z])([A-Z])/g, '$1 $2')
                    .replace(/\b\w/g, c => c.toUpperCase());
            }
        }

        // Helper functions for comparison modal
        function showComparisonLoading(show) {
            document.getElementById('comparisonLoading').style.display = show ? 'block' : 'none';
        }

        function showComparisonError(message) {
            const errorDiv = document.getElementById('comparisonError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideComparisonError() {
            document.getElementById('comparisonError').style.display = 'none';
        }

        let selectedContracts = [];

        // Add checkbox column to contract table and batch search controls
        function addBatchSearchToContractTable() {
            const contractTable = document.getElementById('contractTable');
            if (!contractTable) return;
            
            // Add checkbox column header
            const headerRow = contractTable.querySelector('thead tr');
            if (headerRow && !headerRow.querySelector('.checkbox-col')) {
                const checkboxHeader = document.createElement('th');
                checkboxHeader.className = 'checkbox-col';
                checkboxHeader.style.width = '40px';
                checkboxHeader.innerHTML = '<input type="checkbox" class="select-all-checkbox" onchange="toggleSelectAll(this)">';
                headerRow.insertBefore(checkboxHeader, headerRow.firstChild);
            }
            
            // Add checkbox to each row
            const dataRows = contractTable.querySelectorAll('tbody tr.contract-data-row');
            dataRows.forEach((row, index) => {
                if (!row.querySelector('.checkbox-col')) {
                    const checkboxCell = document.createElement('td');
                    checkboxCell.className = 'checkbox-col';
                    checkboxCell.innerHTML = `<input type="checkbox" class="contract-checkbox" onchange="toggleContractSelection(this)" data-contract-id="${row.dataset.contractId || index}">`;
                    row.insertBefore(checkboxCell, row.firstChild);
                }
            });
            
            // Add batch search controls if not exists
            addBatchSearchControls();
        }

        function addBatchSearchControls() {
            const contractsSection = document.querySelector('.search-results-section');
            if (!contractsSection || document.getElementById('batchSearchControls')) return;
            
            const batchControls = document.createElement('div');
            batchControls.id = 'batchSearchControls';
            batchControls.className = 'batch-search-controls';
            batchControls.innerHTML = `
                <div class="batch-search-header">
                    <div class="batch-search-title">
                        Search in Selected Contracts
                        <span class="selected-count" id="selectedCount">0 selected</span>
                    </div>
                    <div class="batch-actions">
                        <button class="clear-selection-btn" onclick="clearAllSelections()">Clear All</button>
                    </div>
                </div>
                
                <div class="search-input-group">
                    <input type="text" 
                        class="batch-search-input" 
                        id="batchSearchInput" 
                        placeholder="Enter product names or terms to search for (e.g., software, licenses, Microsoft Office)" 
                        onkeypress="handleBatchSearchKeyPress(event)">
                    <button class="batch-search-btn" id="batchSearchBtn" onclick="performBatchSearch()" disabled>
                        Search in Files
                    </button>
                </div>
                
                <div style="font-size: 0.85em; color: #6c757d; margin-top: 5px;">
                    Tip: Separate multiple terms with commas. This will search both the database fields and actual contract file contents.
                </div>
                
                <div class="batch-search-loading" id="batchSearchLoading">
                    <div class="batch-search-spinner"></div>
                    <p id="batchSearchLoadingText">Searching Contract files...</p>
                </div>
            `;
            
            // Insert after the contract filters but before the table
            const filtersDiv = contractsSection.querySelector('div[style*="margin-bottom: 15px"]');
            if (filtersDiv) {
                filtersDiv.parentNode.insertBefore(batchControls, filtersDiv.nextSibling);
            } else {
                contractsSection.insertBefore(batchControls, contractsSection.querySelector('table'));
            }
        }

        // Handle individual checkbox selection
        function toggleContractSelection(checkbox) {
            const contractId = checkbox.dataset.contractId;
            const row = checkbox.closest('tr');
            
            if (checkbox.checked) {
                if (!selectedContracts.includes(contractId)) {
                    selectedContracts.push(contractId);
                    row.style.backgroundColor = '#e3f2fd';
                }
            } else {
                selectedContracts = selectedContracts.filter(id => id !== contractId);
                row.style.backgroundColor = '';
            }
            
            updateBatchSearchControls();
            updateSelectAllCheckbox();
        }

        // Handle select all checkbox
        function toggleSelectAll(selectAllCheckbox) {
            const contractCheckboxes = document.querySelectorAll('.contract-checkbox');
            const visibleRows = Array.from(contractCheckboxes).filter(cb => 
                cb.closest('tr').style.display !== 'none'
            );
            
            if (selectAllCheckbox.checked) {
                visibleRows.forEach(checkbox => {
                    if (!checkbox.checked) {
                        checkbox.checked = true;
                        toggleContractSelection(checkbox);
                    }
                });
            } else {
                visibleRows.forEach(checkbox => {
                    if (checkbox.checked) {
                        checkbox.checked = false;
                        toggleContractSelection(checkbox);
                    }
                });
            }
        }

        // Update select all checkbox state
        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.querySelector('.select-all-checkbox');
            const contractCheckboxes = document.querySelectorAll('.contract-checkbox');
            const visibleCheckboxes = Array.from(contractCheckboxes).filter(cb => 
                cb.closest('tr').style.display !== 'none'
            );
            const checkedVisible = visibleCheckboxes.filter(cb => cb.checked);
            
            if (selectAllCheckbox) {
                if (checkedVisible.length === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else if (checkedVisible.length === visibleCheckboxes.length) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                }
            }
        }

        // Update batch search controls visibility and state
        function updateBatchSearchControls() {
            const batchControls = document.getElementById('batchSearchControls');
            const selectedCount = document.getElementById('selectedCount');
            const searchBtn = document.getElementById('batchSearchBtn');
            
            if (batchControls && selectedCount && searchBtn) {
                if (selectedContracts.length > 0) {
                    batchControls.style.display = 'block';
                    selectedCount.textContent = `${selectedContracts.length} selected`;
                    searchBtn.disabled = false;
                } else {
                    batchControls.style.display = 'none';
                    searchBtn.disabled = true;
                }
            }
        }

        // Clear all selections
        function clearAllSelections() {
            selectedContracts = [];
            
            // Uncheck all checkboxes
            document.querySelectorAll('.contract-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                const row = checkbox.closest('tr');
                if (row) row.style.backgroundColor = '';
            });
            
            // Update select all checkbox
            const selectAllCheckbox = document.querySelector('.select-all-checkbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
            
            updateBatchSearchControls();
            
            // Hide search results
            const existingResults = document.getElementById('batchSearchResults');
            if (existingResults) {
                existingResults.remove();
            }
        }

        // Handle enter key in batch search input
        function handleBatchSearchKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                performBatchSearch();
            }
        }

        // Perform batch search
        async function performBatchSearch() {
            const searchInput = document.getElementById('batchSearchInput');
            const searchTerms = searchInput.value.trim();
            
            if (!searchTerms) {
                alert('Please enter search terms');
                searchInput.focus();
                return;
            }
            
            if (selectedContracts.length === 0) {
                alert('Please select contracts to search');
                return;
            }
            
            console.log('🔍 Starting batch search:', {
                contracts: selectedContracts.length,
                terms: searchTerms
            });
            
            try {
                showBatchSearchLoading(true);
                
                const response = await fetch('/api/contracts/batch-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contractIds: selectedContracts,
                        searchTerms: searchTerms,
                        searchType: 'product'
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Search failed');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayBatchSearchResults(result);
                } else {
                    throw new Error(result.error || 'Search failed');
                }
                
            } catch (error) {
                console.error('Batch search failed:', error);
                alert('Search failed: ' + error.message);
            } finally {
                showBatchSearchLoading(false);
            }
        }

        // Show/hide batch search loading
        function showBatchSearchLoading(show) {
            const loading = document.getElementById('batchSearchLoading');
            if (loading) {
                loading.style.display = show ? 'block' : 'none';
            }
        }

        // Display batch search results
        function displayBatchSearchResults(result) {
            // Remove existing results
            const existingResults = document.getElementById('batchSearchResults');
            if (existingResults) {
                existingResults.remove();
            }
            
            const contractsSection = document.querySelector('.search-results-section');
            if (!contractsSection) return;
            
            const resultsDiv = document.createElement('div');
            resultsDiv.id = 'batchSearchResults';
            resultsDiv.className = 'batch-search-results';
            
            // Only show contracts with matches
            const contractsWithMatches = result.results.filter(contract => contract.matches.length > 0);
            
            let resultsHtml = `
                <div class="search-results-header">
                    <div class="search-results-title">
                        Search Results for "${result.searchTerms}"
                    </div>
                    <div class="search-stats">
                        ${contractsWithMatches.length} contracts found with matches
                    </div>
                </div>
            `;
            
            if (contractsWithMatches.length > 0) {
                resultsHtml += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #374151; margin-bottom: 15px;">
                            Contracts with Matches (${contractsWithMatches.length})
                        </h4>
                `;
                
                contractsWithMatches.forEach(contract => {
                    // Fix file URL if needed
                    let fixedFileUrl = contract.fileUrl;
                    if (fixedFileUrl && fixedFileUrl.includes('ccm-contracts.s3.amazonaws.com')) {
                        fixedFileUrl = fixedFileUrl.replace('ccm-contracts.s3.amazonaws.com', 'ccm-contracts.s3.us-east-1.amazonaws.com');
                    }
                    
                    resultsHtml += `
                        <div class="contract-result-item">
                            <div class="contract-result-header">
                                <div class="contract-result-title">${contract.contractName || 'Unnamed Contract'}</div>
                            </div>
                            
                            <div class="contract-result-details">
                                <div><strong>Vendor:</strong> ${contract.vendorName || 'N/A'}</div>
                                <div><strong>Client:</strong> ${getAttorneyDisplay(contract.clientName) || 'N/A'}</div>
                            </div>
                                ${fixedFileUrl ? `
                                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                                        <button onclick="previewFile('${fixedFileUrl}')" 
                                                class="contract-preview-btn">
                                            Preview Contract
                                        </button>
                                        <button onclick="downloadFile('${fixedFileUrl}', '${(contract.contractName || 'contract').replace(/'/g, '\\\'')}')" 
                                                class="contract-download-btn">
                                            Download Contract
                                        </button>
                                    </div>
                                ` : `
                                    <div style="color: #6c757d; font-size: 0.9em; font-style: italic; margin-top: 12px;">
                                        No file available for this contract
                                    </div>
                                `}
                            </div>
                        </div>
                    `;
                });
                
                resultsHtml += '</div>';
            } else {
                resultsHtml += `
                    <div class="no-matches-item" style="margin: 20px 0;">
                        No contracts found with matches for "${result.searchTerms}"
                    </div>
                `;
            }
            
            // Add search method explanation
            resultsHtml += `
                <div style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 6px; padding: 12px; margin-top: 20px; font-size: 0.9em;">
                    <div style="font-weight: 600; color: #6c757d; margin-bottom: 5px;">Search Method Used:</div>
                    <div style="color: #0c5460;">
                        ${result.searchMethod === 'full_content' 
                            ? '<strong>Full Content Search:</strong> Searched within the actual contract file contents (PDF, Word, etc.) for more accurate results.'
                            : '<strong>Database Search:</strong> Searched in database fields only (product descriptions, contract names). For deeper search, ensure AWS S3 access is configured.'
                        }
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = resultsHtml;
            
            // Insert results after the batch search controls
            const batchControls = document.getElementById('batchSearchControls');
            if (batchControls) {
                batchControls.parentNode.insertBefore(resultsDiv, batchControls.nextSibling);
            } else {
                contractsSection.appendChild(resultsDiv);
            }
            
            // Scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Helper function to format field names
        function formatFieldName(fieldName) {
            const fieldMap = {
                'file_content': 'File Content',
                'product': 'Product Field',
                'contract_name': 'Contract Name',
                'vendor_name': 'Vendor Name'
            };
            return fieldMap[fieldName] || fieldName.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }

        // Helper function to format match context with highlighted terms
        function formatMatchContext(context) {
            if (!context) return '';
            
            // Convert **term** to <strong>term</strong> for highlighting
            return context.replace(/\*\*(.*?)\*\*/g, '<strong style="background: #ffeb3b; padding: 1px 2px; border-radius: 2px; color: #333;">$1</strong>');
        }

        // Override the existing displayCombinedResults function to include batch search setup
        const originalDisplayCombinedResults = window.displayCombinedResults;
        window.displayCombinedResults = function(contracts, jiraTickets, glRecords, searchTerm, selectedSearchTypes) {
            // Call the original function
            originalDisplayCombinedResults(contracts, jiraTickets, glRecords, searchTerm, selectedSearchTypes);
            
            // Add batch search functionality to contracts if they exist
            if (selectedSearchTypes.includes('contracts') && contracts && contracts.length > 0) {
                setTimeout(() => {
                    addBatchSearchToContractTable();
                }, 100);
            }
        };

        // Also add to contract table when filtering
        const originalFilterContractTable = window.filterContractTable;
        window.filterContractTable = function() {
            if (originalFilterContractTable) {
                originalFilterContractTable();
            }
            updateSelectAllCheckbox();
        };

        // Reset selections when clearing filters
        const originalClearContractFilters = window.clearContractFilters;
        window.clearContractFilters = function() {
            if (originalClearContractFilters) {
                originalClearContractFilters();
            }
            clearAllSelections();
        };

        // Reset selections when performing new search
        const authOriginalSearchContractsAndJira = window.searchContractsAndJira;
        window.searchContractsAndJira = function() {
            if (!isAuthenticated) {
                alert('Please login to search contracts');
                window.location.href = '/login.html';
                return;
            }
            return authOriginalSearchContractsAndJira.apply(this, arguments);
        };

        // 清除对话历史
        function clearConversation() {
            conversationHistory = [];
            currentUploadedFile = null;
            removeUploadedFile();
            
            const messagesContainer = document.getElementById('chatbotMessages');
            if (messagesContainer) {
                messagesContainer.innerHTML = `
                    <div class="message bot">
                        <div class="message-avatar">🤖</div>
                        <div class="message-content">
                            Hello! I'm your AI assistant. I can help with any questions or tasks, and I can analyze files you upload.
                            
                            <div class="suggestion-chips">
                                <div class="suggestion-chip" onclick="sendSuggestion('Upload a document to analyze')">Analyze document</div>
                                <div class="suggestion-chip" onclick="sendSuggestion('Help me with code review')">Code review</div>
                                <div class="suggestion-chip" onclick="sendSuggestion('Explain quantum computing')">Quantum computing</div>
                                <div class="suggestion-chip" onclick="sendSuggestion('Help me brainstorm ideas')">Brainstorm</div>
                            </div>
                        </div>
                    </div>
                `;
                createTypingIndicator();
            }
            if (typeof chatHistory !== 'undefined') {
                chatHistory.startNewConversation();
            }
        }

        const domCache = {
            mainSearchInput: null,
            vendorSuggestions: null,
            selectedVendors: null,
            
            init() {
                this.mainSearchInput = document.getElementById('mainSearchInput');
                this.vendorSuggestions = document.getElementById('vendorSuggestions');
                this.selectedVendors = document.getElementById('selectedVendors');
            },
            
            get(id) {
                if (!this[id]) {
                    this[id] = document.getElementById(id);
                }
                return this[id];
            }
        };

        function openComparisonModal(fileUrl, contractName) {
            selectedReferenceContract = { 
                url: fileUrl, 
                name: contractName.replace(/'/g, "\\'")
            };
            
            // 显示参考合同信息
            document.getElementById('referenceContractName').textContent = contractName;
            document.getElementById('contractComparisonModal').style.display = 'block';
            
            // 重置状态
            newContractForComparison = null;
            document.getElementById('newContractInfo').style.display = 'none';
            document.getElementById('startComparisonBtn').disabled = true;
            document.getElementById('comparisonResults').style.display = 'none';
            document.getElementById('comparisonError').style.display = 'none';
            document.getElementById('comparisonLoading').style.display = 'none';
            
            console.log('📋 Modal opened, waiting for new contract upload...');
        }

        // 添加新的直接比较函数（第一个tab使用）
        async function performDirectComparison(referenceFileUrl, referenceContractName) {
            console.log('🔍 Starting direct comparison:', {
                reference: referenceContractName,
                uploaded: selectedFile.name
            });

            // 显示弹窗提示
            showComparisonToast('Comparing contracts... Check results at bottom', 3000);

            // 创建本地loading元素（在similar contracts附近）
            const similarContractsSection = document.querySelector('.results');
            if (!similarContractsSection) return;

            // 添加loading到similar contracts区域
            const loadingHtml = `
                <div id="comparisonLoadingLocal" style="background: #f1f5f9; border-left: 4px solid #475569; padding: 20px; margin: 20px 0; border-radius: 5px; text-align: center;">
                    <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #e2e8f0; border-top: 3px solid #475569; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px;"></div>
                    <span style="color: #475569; font-weight: 600;">Analyzing contract comparison...</span>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            similarContractsSection.insertAdjacentHTML('beforeend', loadingHtml);

            try {
                hideError();

                const formData = new FormData();
                formData.append('uploadedContract', selectedFile);
                formData.append('referenceContractUrl', referenceFileUrl);
                formData.append('referenceContractName', referenceContractName);
                formData.append('useUploadedContract', 'true');

                console.log('📋 Sending direct comparison request...');

                const response = await fetch('/api/compare-contracts', {
                    method: 'POST',
                    body: formData
                });

                console.log('📋 Direct comparison response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('📋 Direct comparison API Error:', errorData);
                    throw new Error(errorData.error || 'Comparison failed');
                }

                const result = await response.json();
                console.log('📋 Direct comparison result received');
                
                if (result.success) {
                    console.log('✅ Direct comparison successful, displaying results...');
                    displayDirectComparisonResults(result.analysis, referenceContractName, selectedFile.name);
                } else {
                    throw new Error(result.error || 'Comparison failed');
                }

            } catch (error) {
                console.error('❌ Direct comparison failed:', error);
                
                // 显示错误在local区域
                const errorHtml = `
                    <div style="background: #fef2f2; border-left: 4px solid #dc2626; padding: 15px; margin: 20px 0; border-radius: 5px;">
                        <strong style="color: #dc2626;">Comparison Error:</strong>
                        <span style="color: #7f1d1d;">${error.message}</span>
                    </div>
                `;
                similarContractsSection.insertAdjacentHTML('beforeend', errorHtml);
            } finally {
                // 移除loading
                const loadingElement = document.getElementById('comparisonLoadingLocal');
                if (loadingElement) {
                    loadingElement.remove();
                }
            }
        }

        // 添加直接比较结果显示函数（第一个tab使用）
        function displayDirectComparisonResults(analysis, referenceContractName, newContractName) {
            const resultsDiv = document.querySelector('.results');
            if (!resultsDiv) return;
            
            const loadingElement = document.getElementById('comparisonLoadingLocal');
                if (loadingElement) {
                    loadingElement.remove();
                }
            
            // 尝试解析JSON
            let jsonData = null;
            try {
                let cleanedAnalysis = analysis.trim();
                cleanedAnalysis = cleanedAnalysis.replace(/```json\s*/g, '').replace(/```\s*/g, '');
                
                const jsonMatch = cleanedAnalysis.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    jsonData = JSON.parse(jsonMatch[0]);
                } else {
                    jsonData = JSON.parse(cleanedAnalysis);
                }
                
                console.log('📋 Successfully parsed comparison JSON:', jsonData);
            } catch (e) {
                console.warn('📋 Failed to parse JSON, showing raw analysis:', e.message);
                
                const errorResultHtml = `
                    <div style="margin-top: 30px; border-top: 2px solid #e2e8f0; padding-top: 20px;">
                        <h3 style="color: #1e40af; margin-bottom: 15px;">Contract Comparison Results</h3>
                        <div style="background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 8px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #475569;">
                            <h4 style="color: #475569;">Comparing:</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                                <div><strong>Reference Contract:</strong><br>${referenceContractName}</div>
                                <div><strong>Your Contract:</strong><br>${newContractName}</div>
                            </div>
                        </div>
                        <div style="padding: 20px; background: #f8fafc; border-radius: 8px; line-height: 1.6; border: 1px solid #e2e8f0;">
                            ${analysis.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `;
                resultsDiv.insertAdjacentHTML('beforeend', errorResultHtml);
                return;
            }

            const exportButtonHtml = `
                <div style="text-align: right; margin: 15px 0;">
                    <button onclick="exportComparisonAnalysis()" 
                            style="background: #1e40af; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                        Export Comparison
                    </button>
                </div>
            `;

            // 设置比较数据用于导出
            analysisExporter.setAnalysisData({
                referenceContract: referenceContractName,
                newContract: newContractName,
                jsonData: jsonData,
                rawAnalysis: analysis
            }, 'contract_comparison');

            // 成功解析JSON，创建结构化显示（删除Contract Overview）
            let comparisonHtml = `
                <div style="margin-top: 30px; border-top: 2px solid #e2e8f0; padding-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #1e40af; border-bottom: 2px solid #475569; padding-bottom: 10px; margin: 0;">Contract Comparison Analysis</h3>
                        ${exportButtonHtml}
                    </div>
                    
                    <div style="background: #f1f5f9; border-left: 4px solid #475569; padding: 20px; margin-bottom: 20px; border-radius: 5px;">
                        <h4 style="color: #1e40af;">Contracts Being Compared</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                            <div>
                                <strong>Reference Contract:</strong><br>
                                <span style="color: #1e40af;">${referenceContractName}</span><br>
                                <small style="color: #64748b;">(From database)</small>
                            </div>
                            <div>
                                <strong>Your Uploaded Contract:</strong><br>
                                <span style="color: #1e40af;">${newContractName}</span><br>
                                <small style="color: #64748b;">(Currently analyzing)</small>
                            </div>
                        </div>
                    </div>
            `;

            // 跳过Contract Overview，直接处理Key Differences
            if (jsonData.key_differences) {
                comparisonHtml += createComparisonSection('Key Differences', jsonData.key_differences);
            }

            // Risk Analysis - 灰色深蓝色系
            if (jsonData.risk_analysis) {
                comparisonHtml += `
                    <div style="background: #f8fafc; border-left: 4px solid #64748b; padding: 20px; margin: 20px 0; border-radius: 5px;">
                        <h4 style="color: #374151;">Risk Analysis</h4>
                `;
                
                if (jsonData.risk_analysis.higher_risk_in_new_contract?.length > 0) {
                    comparisonHtml += `
                        <div style="margin: 10px 0;">
                            <strong style="color: #FBBE24;">Higher Risks in New Contract:</strong>
                            <ul style="margin-top: 5px; color: #FBBE24;">
                                ${jsonData.risk_analysis.higher_risk_in_new_contract.map(risk => `<li>${risk}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                if (jsonData.risk_analysis.lower_risk_in_new_contract?.length > 0) {
                    comparisonHtml += `
                        <div style="margin: 10px 0;">
                            <strong style="color: black;">Lower Risks in New Contract:</strong>
                            <ul style="margin-top: 5px; color: black;">
                                ${jsonData.risk_analysis.lower_risk_in_new_contract.map(risk => `<li>${risk}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                if (jsonData.risk_analysis.overall_risk_assessment) {
                    const riskColor = jsonData.risk_analysis.overall_risk_assessment === 'high' ? '#FBBE24' : 
                                    jsonData.risk_analysis.overall_risk_assessment === 'medium' ? '#1D40AF' : 'black';
                    comparisonHtml += `
                        <div style="margin: 10px 0;">
                            <strong style="color: #374151;">Overall Risk Assessment:</strong>
                            <span style="color: ${riskColor}; font-weight: bold; text-transform: uppercase; background: #f1f5f9; padding: 4px 8px; border-radius: 4px; margin-left: 8px;">
                                ${jsonData.risk_analysis.overall_risk_assessment}
                            </span>
                        </div>
                    `;
                }
                
                comparisonHtml += '</div>';
            }

            // Recommendations - 灰色深蓝色系
            if (jsonData.recommendations) {
                comparisonHtml += `
                    <div style="background: #f1f5f9; border-left: 4px solid #475569; padding: 20px; margin: 20px 0; border-radius: 5px;">
                        <h4 style="color: #1e40af;">Recommendations</h4>
                `;
                
                if (jsonData.recommendations.negotiation_points?.length > 0) {
                    comparisonHtml += `
                        <div style="margin: 10px 0;">
                            <strong style="color: black;">Negotiation Points:</strong>
                            <ul style="margin-top: 5px; color: black;">
                                ${jsonData.recommendations.negotiation_points.map(point => `<li>${point}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                if (jsonData.recommendations.concerns?.length > 0) {
                    comparisonHtml += `
                        <div style="margin: 10px 0;">
                            <strong style="color: #FBBE24;">Major Concerns:</strong>
                            <ul style="margin-top: 5px; color: #FBBE24;">
                                ${jsonData.recommendations.concerns.map(concern => `<li>${concern}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                if (jsonData.recommendations.missing_clauses?.length > 0) {
                    comparisonHtml += `
                        <div style="margin: 10px 0;">
                            <strong style="color: #FBBE24;">Missing Clauses:</strong>
                            <ul style="margin-top: 5px; color: #FBBE24;">
                                ${jsonData.recommendations.missing_clauses.map(clause => `<li>${clause}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                if (jsonData.recommendations.favorable_terms?.length > 0) {
                    comparisonHtml += `
                        <div style="margin: 10px 0;">
                            <strong style="color: black;">Favorable Terms:</strong>
                            <ul style="margin-top: 5px; color: black;">
                                ${jsonData.recommendations.favorable_terms.map(term => `<li>${term}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                comparisonHtml += '</div>';
            }

            // Executive Summary - 灰色深蓝色系
            if (jsonData.summary) {
                comparisonHtml += `
                    <div style="background: #f8fafc; border-left: 4px solid #1e40af; padding: 20px; margin: 20px 0; border-radius: 5px;">
                        <h4 style="color: #1e40af;">Executive Summary</h4>
                        <div style="margin: 10px 0;">
                            <strong style="color: #374151;">Main Differences:</strong> 
                            <span style="color: #4b5563;">${jsonData.summary.main_differences || 'Not specified'}</span>
                        </div>
                        <div style="margin: 10px 0;">
                            <strong style="color: #374151;">Recommendation:</strong>
                            <span style="font-weight: bold; text-transform: uppercase; color: #1e40af; background: #dbeafe; padding: 4px 8px; border-radius: 4px; margin-left: 8px;">
                                ${jsonData.summary.recommendation || 'Not specified'}
                            </span>
                        </div>
                        ${jsonData.summary.priority_actions?.length > 0 ? `
                            <div style="margin: 15px 0;">
                                <strong style="color: #374151;">Priority Actions:</strong>
                                <ol style="margin-top: 8px; color: #4b5563; padding-left: 20px;">
                                    ${jsonData.summary.priority_actions.map(action => `<li style="margin-bottom: 5px;">${action}</li>`).join('')}
                                </ol>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            comparisonHtml += '</div>';
            
            // 添加到results区域末尾
            resultsDiv.insertAdjacentHTML('beforeend', comparisonHtml);
            
            // 滚动到比较结果
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function exportContractAnalysis() {
            analysisExporter.showExportOptions();
        }

        function exportComparisonAnalysis() {
            analysisExporter.showExportOptions();
        }

        // 创建比较区段的辅助函数
        function createComparisonSection(title, data) {
            let sectionHtml = `
                <div style="background: #f8f9fa; border-left: 4px solid #6c757d; padding: 20px; margin: 20px 0; border-radius: 5px;">
                    <h4 style="color: #495057;">${title}</h4>
                    <div style="overflow-x: auto; margin-top: 15px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #e9ecef;">
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Aspect</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Reference Contract</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Your Contract</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            Object.entries(data).forEach(([key, value]) => {
                if (typeof value === 'object' && value.Reference_Contract !== undefined && value.New_Contract !== undefined) {
                    const refValue = value.Reference_Contract || 'Not specified';
                    const newValue = value.New_Contract || 'Not specified';
                    const isDifferent = refValue !== newValue;
                    
                    sectionHtml += `
                        <tr style="${isDifferent ? 'background: #F1F5F9;' : ''}">
                            <td style="padding: 10px; border: 1px solid #dee2e6; font-weight: bold;">
                                ${key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}
                            </td>
                            <td style="padding: 10px; border: 1px solid #dee2e6;">${refValue}</td>
                            <td style="padding: 10px; border: 1px solid #dee2e6; ${isDifferent ? 'font-weight: bold; color: #f57c00;' : ''}">${newValue}</td>
                        </tr>
                    `;
                }
            });

            sectionHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            return sectionHtml;
        }

        // Handle new contract upload for comparison (第二个tab使用)
        function handleNewContractUpload(input) {
            const file = input.files?.[0];
            if (file) {
                newContractForComparison = file;
                console.log('📋 New contract uploaded:', file.name, file.type, file.size);
                
                const fileInfo = document.getElementById('newContractInfo');
                fileInfo.innerHTML = 
                    '<strong>Selected:</strong> ' + file.name + '<br>' +
                    '<strong>Size:</strong> ' + (file.size / 1024 / 1024).toFixed(2) + ' MB';
                fileInfo.style.display = 'block';
                
                document.getElementById('startComparisonBtn').disabled = false;
                console.log('📋 Comparison button enabled');
            }
        }

        // Start contract comparison (第二个tab使用 - 模态框中的比较)
        async function startContractComparison() {
            if (!selectedReferenceContract || !newContractForComparison) {
                showComparisonError('Please select both contracts');
                return;
            }

            console.log('📋 Starting modal comparison:', {
                reference: selectedReferenceContract,
                newContract: newContractForComparison.name
            });

            // 显示弹窗提示（模态框版本）
            showComparisonToast('Comparing contracts... Check results in modal', 3000);

            try {
                showComparisonLoading(true);
                hideComparisonError();

                const formData = new FormData();
                formData.append('newContract', newContractForComparison);
                formData.append('referenceContractUrl', selectedReferenceContract.url);
                formData.append('referenceContractName', selectedReferenceContract.name);
                formData.append('useUploadedContract', 'false');

                console.log('📋 Sending modal comparison request to /api/compare-contracts...');

                const response = await fetch('/api/compare-contracts', {
                    method: 'POST',
                    body: formData
                });

                console.log('📋 Modal comparison response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('📋 Modal comparison API Error:', errorData);
                    throw new Error(errorData.error || 'Comparison failed');
                }

                const result = await response.json();
                console.log('📋 Modal comparison result:', result);
                
                if (result.success) {
                    console.log('✅ Modal comparison successful, displaying results...');
                    displayModalComparisonResults(result.analysis);
                } else {
                    throw new Error(result.error || 'Comparison failed');
                }

            } catch (error) {
                console.error('❌ Modal comparison failed:', error);
                showComparisonError('Comparison failed: ' + error.message);
            } finally {
                showComparisonLoading(false);
            }
        }

        // 显示模态框比较结果（第二个tab使用）
        function displayModalComparisonResults(analysis) {
            const resultsDiv = document.getElementById('comparisonResults');
            resultsDiv.innerHTML = '';
            resultsDiv.style.display = 'block';

            console.log('📋 Raw modal analysis received:', analysis);

            // 尝试解析JSON（复用现有逻辑）
            let jsonData = null;
            try {
                let cleanedAnalysis = analysis.trim();
                cleanedAnalysis = cleanedAnalysis.replace(/```json\s*/g, '').replace(/```\s*/g, '');
                
                const jsonMatch = cleanedAnalysis.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    jsonData = JSON.parse(jsonMatch[0]);
                } else {
                    jsonData = JSON.parse(cleanedAnalysis);
                }
                
                console.log('📋 Successfully parsed modal comparison JSON');
            } catch (e) {
                console.warn('📋 Failed to parse modal JSON, showing raw analysis:', e.message);
                
                resultsDiv.innerHTML = `
                    <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #856404; margin-bottom: 10px;">Can't parse JSON format</h4>
                        <p style="color: #856404; margin-bottom: 10px;">Results:</p>
                        <details style="margin-top: 10px;">
                            <summary style="color: #856404; cursor: pointer;">Check Original Data</summary>
                            <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 0.8em; margin-top: 10px; white-space: pre-wrap;">${analysis}</pre>
                        </details>
                    </div>
                    <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; line-height: 1.6;">
                        ${analysis.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}
                    </div>
                `;
                return;
            }

            // 成功解析JSON，创建比较界面（复用现有的createSection逻辑）
            console.log('📋 Parsed modal JSON data:', jsonData);
            
            const mainContainer = document.createElement('div');
            mainContainer.style.cssText = `
                background: #f8f9fa;
                border-radius: 8px;
                padding: 16px;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            `;

            const titleDiv = document.createElement('div');
            titleDiv.innerHTML = `
                <h3 style="color: #2c3e50; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #dee2e6; font-size: 1.3em;">
                    Contract Comparison Analysis
                </h3>
            `;
            mainContainer.appendChild(titleDiv);

            // 渲染每个主要部分
            Object.entries(jsonData).forEach(([sectionKey, sectionData]) => {
                if (typeof sectionData === 'object' && sectionData !== null) {
                    const sectionDiv = createModalSection(sectionKey, sectionData, 0);
                    mainContainer.appendChild(sectionDiv);
                }
            });

            resultsDiv.appendChild(mainContainer);
        }

        // Helper functions for modal comparison
        function hasComparisonStructure(data) {
            if (typeof data !== 'object' || data === null) return false;
            return data.hasOwnProperty('Reference_Contract') || data.hasOwnProperty('New_Contract');
        }

        function formatCellValue(value) {
            if (value === null || value === undefined) return '—';
            if (Array.isArray(value)) {
                if (value.length > 0 && value.every(item => typeof item === 'string' && item.length <= 1)) {
                    return value.join('');
                }
                return value.join(', ');
            }
            if (typeof value === 'object') {
                return JSON.stringify(value, null, 2);
            }
            return value.toString();
        }

        function formatSectionTitle(title) {
            return title
                .replace(/_/g, ' ')
                .replace(/([a-z])([A-Z])/g, '$1 $2')
                .replace(/\b\w/g, c => c.toUpperCase());
        }

        // 为模态框创建章节（复用直接比较的逻辑）
        function createModalSection(sectionKey, sectionData, level) {
            const sectionDiv = document.createElement('div');
            sectionDiv.style.cssText = `
                margin-bottom: ${level === 0 ? '16px' : '12px'};
                padding: ${level === 0 ? '16px' : '12px'};
                background: ${level === 0 ? '#ffffff' : '#f1f3f4'};
                border-radius: 6px;
                border-left: 3px solid ${level === 0 ? '#6c757d' : '#adb5bd'};
                box-shadow: ${level === 0 ? '0 1px 3px rgba(0,0,0,0.06)' : 'none'};
            `;

            // 创建章节标题
            const titleDiv = document.createElement('div');
            titleDiv.innerHTML = `
                <h${Math.min(4 + level, 6)} style="
                    color: #495057; 
                    margin-bottom: 10px; 
                    font-size: ${1.1 - level * 0.08}em;
                    font-weight: 600;
                ">
                    ${formatSectionTitle(sectionKey)}
                </h${Math.min(4 + level, 6)}>
            `;
            sectionDiv.appendChild(titleDiv);

            // 检查是否是对比节点
            if (hasComparisonStructure(sectionData)) {
                const comparisonTable = createModalComparisonTable(sectionData);
                sectionDiv.appendChild(comparisonTable);
            } else if (typeof sectionData === 'object' && !Array.isArray(sectionData)) {
                // 递归处理子章节
                Object.entries(sectionData).forEach(([key, value]) => {
                    if (typeof value === 'object' && value !== null) {
                        const subSection = createModalSection(key, value, level + 1);
                        sectionDiv.appendChild(subSection);
                    } else {
                        // 显示简单的键值对
                        const valueDiv = document.createElement('div');
                        valueDiv.style.cssText = `
                            background: #e9ecef;
                            padding: 8px 10px;
                            border-radius: 3px;
                            color: #495057;
                            margin: 4px 0;
                            font-size: 0.85em;
                            line-height: 1.3;
                        `;
                        valueDiv.innerHTML = `<strong>${formatSectionTitle(key)}:</strong> ${value || '—'}`;
                        sectionDiv.appendChild(valueDiv);
                    }
                });
            } else {
                // 显示普通值
                const valueDiv = document.createElement('div');
                valueDiv.style.cssText = `
                    background: #e9ecef;
                    padding: 8px 10px;
                    border-radius: 3px;
                    color: #495057;
                    font-size: 0.85em;
                    margin-top: 4px;
                    line-height: 1.3;
                `;
                valueDiv.textContent = sectionData?.toString() || '—';
                sectionDiv.appendChild(valueDiv);
            }

            return sectionDiv;
        }

        // 为模态框创建对比表格
        function createModalComparisonTable(data) {
            const table = document.createElement('div');
            table.style.cssText = `
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 1px;
                background: #dee2e6;
                border-radius: 4px;
                overflow: hidden;
                margin-top: 6px;
            `;

            // 表头
            ['Summary', 'Reference Contract', 'New Contract'].forEach(header => {
                const headerCell = document.createElement('div');
                headerCell.style.cssText = `
                    background: #6c757d;
                    color: white;
                    padding: 8px 10px;
                    font-weight: 600;
                    font-size: 0.85em;
                    text-align: center;
                `;
                headerCell.textContent = header;
                table.appendChild(headerCell);
            });

            // 处理比较数据
            if (data.Reference_Contract || data.New_Contract) {
                const refData = data.Reference_Contract || {};
                const newData = data.New_Contract || {};
                
                if (typeof refData === 'object' && typeof newData === 'object') {
                    const allFields = new Set([...Object.keys(refData), ...Object.keys(newData)]);
                    
                    allFields.forEach(field => {
                        addModalComparisonRow(table, field, refData[field], newData[field]);
                    });
                } else {
                    addModalComparisonRow(table, 'Content', refData, newData);
                }
            } else {
                Object.entries(data).forEach(([key, value]) => {
                    if (typeof value === 'object' && value !== null) {
                        if (value.Reference_Contract || value.New_Contract) {
                            addModalComparisonRow(table, key, value.Reference_Contract, value.New_Contract);
                        }
                    }
                });
            }

            return table;
        }

        // 为模态框添加对比行
        function addModalComparisonRow(table, fieldName, refValue, newValue) {
            // 字段名称
            const fieldCell = document.createElement('div');
            fieldCell.style.cssText = `
                background: #e9ecef;
                padding: 8px 10px;
                font-weight: 500;
                color: #495057;
                border-right: 1px solid #dee2e6;
                font-size: 0.85em;
            `;
            fieldCell.textContent = formatSectionTitle(fieldName);
            table.appendChild(fieldCell);

            const refText = formatCellValue(refValue);
            const newText = formatCellValue(newValue);

            // 参考合同值
            const refCell = document.createElement('div');
            refCell.style.cssText = `
                background: #f8f9fa;
                padding: 8px 10px;
                color: #6c757d;
                border-right: 1px solid #dee2e6;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                font-size: 0.85em;
                word-wrap: break-word;
                line-height: 1.3;
            `;
            refCell.textContent = refText;
            table.appendChild(refCell);

            // 新合同值
            const newCell = document.createElement('div');
            const isDifferent = refText !== newText && newText !== '—' && refText !== '—';
            
            newCell.style.cssText = `
                background: ${isDifferent ? '#E9ECEF' : '#E9ECEF'};
                color: ${isDifferent ? '#6c757d' : '#6c757d'};
                padding: 8px 10px;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                font-size: 0.85em;
                font-weight: ${isDifferent ? '600' : 'normal'};
                word-wrap: break-word;
                line-height: 1.3;
                position: relative;
            `;
            
            if (isDifferent) {
                newCell.style.borderLeft = '3px solid white';
            }
            
            newCell.textContent = newText;
            table.appendChild(newCell);
        }

        function showComparisonToast(message, duration = 3000) {
            // 移除已存在的toast
            const existingToast = document.getElementById('comparisonToast');
            if (existingToast) {
                existingToast.remove();
            }

            // 创建toast元素
            const toast = document.createElement('div');
            toast.id = 'comparisonToast';
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
                color: white;
                padding: 20px 30px;
                border-radius: 12px;
                box-shadow: 0 10px 25px rgba(30, 64, 175, 0.3);
                z-index: 10000;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                font-size: 16px;
                font-weight: 600;
                text-align: center;
                min-width: 300px;
                opacity: 0;
                animation: toastFadeIn 0.3s ease-out forwards;
                border: 2px solid rgba(255, 255, 255, 0.2);
            `;

            // 添加动画样式
            if (!document.getElementById('toastStyles')) {
                const style = document.createElement('style');
                style.id = 'toastStyles';
                style.textContent = `
                    @keyframes toastFadeIn {
                        0% {
                            opacity: 0;
                            transform: translate(-50%, -50%) scale(0.8);
                        }
                        100% {
                            opacity: 1;
                            transform: translate(-50%, -50%) scale(1);
                        }
                    }
                    @keyframes toastFadeOut {
                        0% {
                            opacity: 1;
                            transform: translate(-50%, -50%) scale(1);
                        }
                        100% {
                            opacity: 0;
                            transform: translate(-50%, -50%) scale(0.8);
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            toast.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <div style="width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <span>${message}</span>
                </div>
            `;

            // 添加spin动画
            const spinStyle = document.createElement('style');
            spinStyle.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(spinStyle);

            document.body.appendChild(toast);

            // 自动移除toast
            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.style.animation = 'toastFadeOut 0.3s ease-in forwards';
                    setTimeout(() => {
                        if (toast && toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, duration);
        }

        class AnalysisExporter {
            constructor() {
                this.analysisData = null;
                this.analysisType = null;
            }

            setAnalysisData(data, type) {
                this.analysisData = data;
                this.analysisType = type;
            }

            exportAsHTML() {
                if (!this.analysisData) return;

                const htmlContent = this.generateHTMLReport();
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `${this.analysisType}_analysis_${new Date().toISOString().split('T')[0]}.html`;
                link.click();
                
                URL.revokeObjectURL(url);
            }

            exportAsWord() {
                if (!this.analysisData) return;

                const wordContent = this.generateWordDocument();
                const blob = new Blob([wordContent], { 
                    type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' 
                });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `${this.analysisType}_analysis_${new Date().toISOString().split('T')[0]}.docx`;
                link.click();
                
                URL.revokeObjectURL(url);
            }

            generateHTMLReport() {
                const currentDate = new Date().toLocaleString();
                
                let content = '';
                
                if (this.analysisType === 'contract_analysis') {
                    content = this.generateContractAnalysisHTML();
                } else if (this.analysisType === 'contract_comparison') {
                    content = this.generateComparisonHTML();
                } else if (this.analysisType === 'database_comparison') {
                    content = this.generateDatabaseComparisonHTML();
                }

                return `
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${this.getReportTitle()}</title>
            <style>
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    line-height: 1.6;
                    color: #333;
                    max-width: 1200px;
                    margin: 0 auto;
                    padding: 20px;
                    background: #fff;
                }
                .header {
                    text-align: center;
                    border-bottom: 3px solid #1e40af;
                    padding-bottom: 20px;
                    margin-bottom: 30px;
                }
                .header h1 {
                    color: #1e40af;
                    margin-bottom: 10px;
                    font-size: 2.5em;
                }
                .header .subtitle {
                    color: #6b7280;
                    font-size: 1.1em;
                }
                .section {
                    margin-bottom: 30px;
                    padding: 20px;
                    border-left: 4px solid #e5e7eb;
                    background: #f9fafb;
                    border-radius: 0 8px 8px 0;
                }
                .section h2 {
                    color: #374151;
                    border-bottom: 2px solid #d1d5db;
                    padding-bottom: 10px;
                    margin-bottom: 15px;
                }
                .section h3 {
                    color: #4b5563;
                    margin-top: 20px;
                    margin-bottom: 10px;
                }
                .risk-high { border-left-color: #dc2626; background: #fef2f2; }
                .risk-medium { border-left-color: #d97706; background: #fffbeb; }
                .risk-low { border-left-color: #059669; background: #ecfdf5; }
                .recommendations { border-left-color: #1e40af; background: #eff6ff; }
                .summary { border-left-color: #059669; background: #f0fdf4; }
                .comparison-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 15px 0;
                    background: white;
                    border-radius: 8px;
                    overflow: hidden;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                }
                .comparison-table th {
                    background: #374151;
                    color: white;
                    padding: 12px;
                    text-align: left;
                    font-weight: 600;
                }
                .comparison-table td {
                    padding: 10px 12px;
                    border-bottom: 1px solid #e5e7eb;
                }
                .comparison-table tbody tr:nth-child(even) {
                    background: #f9fafb;
                }
                .highlight-different {
                    background: #fef3c7 !important;
                    font-weight: 600;
                    color: #d97706;
                }
                ul, ol {
                    padding-left: 20px;
                }
                li {
                    margin-bottom: 5px;
                }
                .badge {
                    display: inline-block;
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 0.8em;
                    font-weight: bold;
                    text-transform: uppercase;
                }
                .badge-high { background: #fecaca; color: #7f1d1d; }
                .badge-medium { background: #fed7aa; color: #9a3412; }
                .badge-low { background: #bbf7d0; color: #14532d; }
                .footer {
                    margin-top: 40px;
                    padding-top: 20px;
                    border-top: 2px solid #e5e7eb;
                    text-align: center;
                    color: #6b7280;
                    font-size: 0.9em;
                }
                @media print {
                    body { margin: 0; padding: 15px; }
                    .section { break-inside: avoid; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>${this.getReportTitle()}</h1>
                <div class="subtitle">Generated on ${currentDate}</div>
            </div>
            
            ${content}
            
            <div class="footer">
                <p>This analysis was generated by the Vendor Benchmarking System</p>
            </div>
        </body>
        </html>`;
            }

            generateContractAnalysisHTML() {
                const data = this.analysisData;
                let html = '';

                // Contract Summary
                if (data.contractSummary) {
                    html += `
                        <div class="section summary">
                            <h2>Contract Summary</h2>
                            <table class="comparison-table">
                                <tr><td><strong>Contract Type:</strong></td><td>${data.contractSummary.contract_type || 'Not specified'}</td></tr>
                                <tr><td><strong>Vendor:</strong></td><td>${data.contractSummary.vendor_name || 'Not specified'}</td></tr>
                                <tr><td><strong>Estimated Value:</strong></td><td>${data.contractSummary.estimated_value || 'Not specified'}</td></tr>
                                <tr><td><strong>Currency:</strong></td><td>${data.contractSummary.currency || 'Not specified'}</td></tr>
                                <tr><td><strong>Risk Level:</strong></td><td><span class="badge badge-${data.contractSummary.risk_level || 'medium'}">${(data.contractSummary.risk_level || 'medium').toUpperCase()}</span></td></tr>
                                <tr><td><strong>Legal Review Required:</strong></td><td>${data.contractSummary.requires_legal_review ? 'YES' : 'NO'}</td></tr>
                            </table>
                        </div>
                    `;
                }

                // YOY Analysis
                if (data.contractSummary?.yoy_increases) {
                    const yoy = data.contractSummary.yoy_increases;
                    html += `
                        <div class="section">
                            <h2>Year-over-Year Increases Analysis</h2>
                            <p><strong>Found:</strong> ${yoy.found ? 'Yes' : 'No'}</p>
                            ${yoy.percentage ? `<p><strong>Current Percentage:</strong> ${yoy.percentage}</p>` : ''}
                            ${yoy.industry_standard ? `<p><strong>Industry Standard:</strong> ${yoy.industry_standard}</p>` : ''}
                            ${yoy.recommendation ? `<p><strong>Recommendation:</strong> ${yoy.recommendation}</p>` : ''}
                        </div>
                    `;
                }

                // Pricing Issues
                if (data.contractSummary?.incomplete_pricing_sections?.length > 0) {
                    html += `
                        <div class="section risk-high">
                            <h2>Incomplete Pricing Sections</h2>
                            <p>The following sections mention products/services but lack clear pricing:</p>
                            <ul>
                                ${data.contractSummary.incomplete_pricing_sections.map(section => `<li>${section}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                // Key Terms
                if (data.contractSummary?.key_terms?.length > 0) {
                    html += `
                        <div class="section">
                            <h2>Key Terms</h2>
                            <ul>
                                ${data.contractSummary.key_terms.map(term => `<li>${term}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                // Detailed Analysis
                if (data.detailedAnalysis) {
                    html += `
                        <div class="section">
                            <h2>Detailed Analysis</h2>
                            <div style="white-space: pre-wrap; line-height: 1.6;">
                                ${data.detailedAnalysis.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}
                            </div>
                        </div>
                    `;
                }

                return html;
            }

            generateComparisonHTML() {
                const data = this.analysisData;
                let html = '';

                // Contracts Being Compared
                html += `
                    <div class="section">
                        <h2>Contracts Being Compared</h2>
                        <table class="comparison-table">
                            <tr>
                                <td><strong>Reference Contract:</strong></td>
                                <td>${data.referenceContract}</td>
                                <td><em>(From database)</em></td>
                            </tr>
                            <tr>
                                <td><strong>Your Contract:</strong></td>
                                <td>${data.newContract}</td>
                                <td><em>(Currently analyzing)</em></td>
                            </tr>
                        </table>
                    </div>
                `;

                // Key Differences
                if (data.jsonData?.key_differences) {
                    html += `
                        <div class="section">
                            <h2>Key Differences</h2>
                            <table class="comparison-table">
                                <thead>
                                    <tr>
                                        <th>Aspect</th>
                                        <th>Reference Contract</th>
                                        <th>Your Contract</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    Object.entries(data.jsonData.key_differences).forEach(([key, value]) => {
                        if (typeof value === 'object' && value.Reference_Contract !== undefined && value.New_Contract !== undefined) {
                            const refValue = value.Reference_Contract || 'Not specified';
                            const newValue = value.New_Contract || 'Not specified';
                            const isDifferent = refValue !== newValue;

                            html += `
                                <tr>
                                    <td><strong>${key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</strong></td>
                                    <td>${refValue}</td>
                                    <td class="${isDifferent ? 'highlight-different' : ''}">${newValue}</td>
                                </tr>
                            `;
                        }
                    });

                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                // Risk Analysis
                if (data.jsonData?.risk_analysis) {
                    const risk = data.jsonData.risk_analysis;
                    html += `
                        <div class="section risk-${risk.overall_risk_assessment || 'medium'}">
                            <h2>Risk Analysis</h2>
                            <p><strong>Overall Risk Assessment:</strong> <span class="badge badge-${risk.overall_risk_assessment || 'medium'}">${(risk.overall_risk_assessment || 'medium').toUpperCase()}</span></p>
                    `;

                    if (risk.higher_risk_in_new_contract?.length > 0) {
                        html += `
                            <h3>Higher Risks in New Contract:</h3>
                            <ul>
                                ${risk.higher_risk_in_new_contract.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        `;
                    }

                    if (risk.lower_risk_in_new_contract?.length > 0) {
                        html += `
                            <h3>Lower Risks in New Contract:</h3>
                            <ul>
                                ${risk.lower_risk_in_new_contract.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        `;
                    }

                    html += '</div>';
                }

                // Recommendations
                if (data.jsonData?.recommendations) {
                    const rec = data.jsonData.recommendations;
                    html += `
                        <div class="section recommendations">
                            <h2>Recommendations</h2>
                    `;

                    if (rec.negotiation_points?.length > 0) {
                        html += `
                            <h3>Negotiation Points:</h3>
                            <ul>
                                ${rec.negotiation_points.map(point => `<li>${point}</li>`).join('')}
                            </ul>
                        `;
                    }

                    if (rec.concerns?.length > 0) {
                        html += `
                            <h3>Major Concerns:</h3>
                            <ul>
                                ${rec.concerns.map(concern => `<li>${concern}</li>`).join('')}
                            </ul>
                        `;
                    }

                    if (rec.missing_clauses?.length > 0) {
                        html += `
                            <h3>Missing Clauses:</h3>
                            <ul>
                                ${rec.missing_clauses.map(clause => `<li>${clause}</li>`).join('')}
                            </ul>
                        `;
                    }

                    html += '</div>';
                }

                // Executive Summary
                if (data.jsonData?.summary) {
                    const summary = data.jsonData.summary;
                    html += `
                        <div class="section summary">
                            <h2>Executive Summary</h2>
                            <p><strong>Main Differences:</strong> ${summary.main_differences || 'Not specified'}</p>
                            <p><strong>Recommendation:</strong> <span class="badge badge-low">${(summary.recommendation || 'Not specified').toUpperCase()}</span></p>
                            ${summary.priority_actions?.length > 0 ? `
                                <h3>Priority Actions:</h3>
                                <ol>
                                    ${summary.priority_actions.map(action => `<li>${action}</li>`).join('')}
                                </ol>
                            ` : ''}
                        </div>
                    `;
                }

                return html;
            }

            getReportTitle() {
                const titles = {
                    'contract_analysis': 'Contract Analysis Report',
                    'contract_comparison': 'Contract Comparison Report', 
                    'database_comparison': 'Database Comparison Report'
                };
                return titles[this.analysisType] || 'Analysis Report';
            }

            showExportOptions() {
                if (!this.analysisData) {
                    alert('No analysis data available to export');
                    return;
                }

                const modal = document.createElement('div');
                modal.id = 'exportModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;

                modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 400px; width: 90%;">
                        <h3 style="margin-bottom: 20px; color: #1e40af;">Export Analysis Report</h3>
                        
                        <button onclick="analysisExporter.exportAsHTML(); closeExportModal()" 
                                style="width: 100%; margin-bottom: 10px; background: #1e40af; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 1em; transition: all 0.3s ease;">
                            Export as HTML
                        </button>
                        
                        <button onclick="closeExportModal()" 
                                style="width: 100%; background: #6b7280; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease;">
                            Cancel
                        </button>
                    </div>
                `;

                // 添加点击外部关闭功能
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeExportModal();
                    }
                });

                document.body.appendChild(modal);
            }
        }

        const analysisExporter = new AnalysisExporter();

        function closeExportModal() {
            const modal = document.getElementById('exportModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // 注入增强样式的函数
        function injectEnhancedHistoryStyles() {
            if (!document.getElementById('enhancedHistoryStyles')) {
                const styleElement = document.createElement('style');
                styleElement.id = 'enhancedHistoryStyles';
                styleElement.textContent = `
                    .history-item {
                        display: flex;
                        align-items: center;
                        background: white;
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        margin-bottom: 8px;
                        padding: 12px;
                        cursor: pointer;
                        transition: all 0.2s;
                        position: relative;
                    }

                    .history-item:hover {
                        background: #f1f5f9;
                        border-color: #6b7280;
                        transform: translateY(-1px);
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    }

                    .history-item.active {
                        background: #dbeafe;
                        border-color: #3b82f6;
                        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
                    }

                    .history-item-content {
                        flex: 1;
                        min-width: 0;
                    }

                    .history-title {
                        font-weight: 600;
                        color: #2c3e50;
                        font-size: 0.9em;
                        margin-bottom: 4px;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    }

                    .history-date {
                        font-size: 0.75em;
                        color: #6b7280;
                        margin-bottom: 2px;
                    }

                    .history-preview {
                        font-size: 0.7em;
                        color: #9ca3af;
                        font-style: italic;
                    }

                    .history-delete {
                        background: #dc2626;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 24px;
                        height: 24px;
                        cursor: pointer;
                        font-size: 0.8em;
                        margin-left: 8px;
                        transition: all 0.2s;
                        opacity: 0.7;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }

                    .history-delete:hover {
                        background: #b91c1c;
                        transform: scale(1.1);
                        opacity: 1;
                    }

                    .history-item:not(:hover) .history-delete {
                        opacity: 0.5;
                    }

                    .history-loading {
                        text-align: center;
                        padding: 20px;
                        color: #6b7280;
                        font-style: italic;
                    }

                    .history-loading::before {
                        content: "⏳";
                        margin-right: 8px;
                    }

                    .history-empty {
                        text-align: center;
                        padding: 40px 20px;
                        color: #9ca3af;
                    }

                    .history-empty::before {
                        content: "💬";
                        display: block;
                        font-size: 2em;
                        margin-bottom: 10px;
                    }

                    @media (max-width: 768px) {
                        #chatHistoryPanel {
                            padding: 15px !important;
                        }
                        
                        .history-item {
                            padding: 10px !important;
                        }
                        
                        .history-title {
                            font-size: 0.85em !important;
                        }
                        
                        .history-delete {
                            width: 20px !important;
                            height: 20px !important;
                            font-size: 0.7em !important;
                        }
                    }
                `;
                document.head.appendChild(styleElement);
            }
        }

        // 在页面加载时注入样式
        document.addEventListener('DOMContentLoaded', function() {
            injectEnhancedHistoryStyles();
        });

        // 离线状态检测和处理
        let isOnline = navigator.onLine;
        let offlineQueue = [];

        window.addEventListener('online', function() {
            isOnline = true;
            console.log('🟢 Connection restored');
            
            if (offlineQueue.length > 0 && chatHistory) {
                console.log(`📤 Processing ${offlineQueue.length} queued operations`);
                offlineQueue.forEach(operation => {
                    operation().catch(console.error);
                });
                offlineQueue = [];
            }
        });

        window.addEventListener('offline', function() {
            isOnline = false;
            console.log('🔴 Connection lost - entering offline mode');
        });

        function queueOfflineOperation(operation) {
            if (!isOnline) {
                offlineQueue.push(operation);
                return true;
            }
            return false;
        }

        // Contract search functionality
        async function performContractSearch() {
            const contractName = document.getElementById('contractNameSearch').value.trim();
            const productName = document.getElementById('productNameSearch').value.trim();
            const vendorName = document.getElementById('vendorNameSearch').value.trim();
            
            // Check if at least one search criteria is provided
            if (!contractName && !productName && !vendorName) {
                showContractSearchError('Please enter at least one search criteria');
                return;
            }
            
            console.log('🔍 Contract search:', { contractName, productName, vendorName });
            
            try {
                showContractSearchLoading(true);
                hideContractSearchError();
                
                const response = await fetch('/api/contracts/advanced-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contractName: contractName,
                        productName: productName,
                        vendorName: vendorName
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Search failed');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayContractSearchResults(result.contracts);
                } else {
                    throw new Error(result.error || 'Search failed');
                }
                
            } catch (error) {
                console.error('Contract search failed:', error);
                showContractSearchError('Search failed: ' + error.message);
            } finally {
                showContractSearchLoading(false);
            }
        }

        function displayContractSearchResults(contracts) {
            const resultsDiv = document.getElementById('contractSearchResults');
            
            if (!contracts || contracts.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="search-results-section">
                        <h3>Search Results</h3>
                        <p>No contracts found matching your search criteria.</p>
                    </div>
                `;
                return;
            }
            
            // Build results HTML
            let resultsHtml = `
                <div class="search-results-section">
                    <h3>Contract Search Results</h3>
                    <p style="margin-bottom: 15px; color: #6c757d;">Found ${contracts.length} contract(s)</p>
                    
                    <div style="overflow-x: auto;">
                        <table class="contracts-table">
                            <thead>
                                <tr>
                                    <th class="col-contract-id">Contract ID</th>
                                    <th class="col-client">Client</th>
                                    <th class="col-contract-name">Contract Name</th>
                                    <th class="col-vendor">Vendor</th>
                                    <th>Contact Person</th>
                                    <th>Contact Email</th>
                                    <th class="col-period">Contract Period</th>
                                    <th class="col-spend">Spend</th>
                                    <th class="col-file">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            contracts.forEach(contract => {
                const clnumKey = parseInt(contract.clnum);
                const clientName = clientMapping[clnumKey] || `Client ${contract.clnum}`;
                const attorneyDisplay = getAttorneyDisplay(clientName);
                
                const spendDisplay = contract.spend
                    ? (contract.currency
                        ? contract.currency + formatNumber(contract.spend)
                        : '$' + formatNumber(contract.spend))
                    : '$0.00';
                
                let fixedFileUrl = contract.file;
                if (fixedFileUrl && fixedFileUrl.includes('ccm-contracts.s3.amazonaws.com')) {
                    fixedFileUrl = fixedFileUrl.replace('ccm-contracts.s3.amazonaws.com', 'ccm-contracts.s3.us-east-1.amazonaws.com');
                }
                
                resultsHtml += `
                    <tr>
                        <td class="col-contract-id">${contract.contract_id || contract.id || 'N/A'}</td>
                        <td class="col-client"><strong>${attorneyDisplay}</strong></td>
                        <td class="col-contract-name">${contract.contract_name || 'N/A'}</td>
                        <td class="col-vendor">${contract.vendor_name || 'N/A'}</td>
                        <td>${contract.vendor_contact_name || 'N/A'}</td>
                        <td>${contract.vendor_contact_email || 'N/A'}</td>
                        <td class="col-period">
                            <div style="font-size: 0.85em;">
                                <strong>Start:</strong> ${formatDateFromNumber(contract.start_date)}<br>
                                <strong>End:</strong> ${formatDateFromNumber(contract.end_date)}
                            </div>
                        </td>
                        <td class="col-spend">${spendDisplay}</td>
                        <td class="col-file">
                            ${fixedFileUrl ? 
                                `<button onclick="previewFile('${fixedFileUrl}')" style="background: #1e3a8a; color: white; border: none; padding: 3px 6px; border-radius: 4px; cursor: pointer; font-size: 0.75em; margin-bottom: 3px; width: 100%;">Preview</button><br>
                                <button onclick="downloadFile('${fixedFileUrl}', '${(contract.contract_name || 'contract').replace(/'/g, '\\\'')}')" style="background: #3b82f6; color: white; border: none; padding: 3px 6px; border-radius: 4px; cursor: pointer; font-size: 0.75em; width: 100%;">Download</button>`
                                : '<span style="color: #6c757d; font-size: 0.8em;">No file</span>'
                            }
                        </td>
                    </tr>
                `;
            });
            
            resultsHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = resultsHtml;
        }

        function clearContractSearchFilters() {
            document.getElementById('contractNameSearch').value = '';
            document.getElementById('productNameSearch').value = '';
            document.getElementById('vendorNameSearch').value = '';
            document.getElementById('contractSearchResults').innerHTML = '';
            hideContractSearchError();
        }

        function showContractSearchLoading(show) {
            const loading = document.getElementById('contractSearchLoading');
            if (loading) {
                loading.style.display = show ? 'block' : 'none';
            }
        }

        function showContractSearchError(message) {
            const errorDiv = document.getElementById('contractSearchError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        function hideContractSearchError() {
            const errorDiv = document.getElementById('contractSearchError');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }

        // Add Enter key support for search inputs
        document.addEventListener('DOMContentLoaded', function() {
            const searchInputs = ['contractNameSearch', 'productNameSearch', 'vendorNameSearch'];
            
            searchInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('keypress', function(event) {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            performContractSearch();
                        }
                    });
                }
            });
        });

    </script>
    <!-- Contract Comparison Modal -->
    <div id="contractComparisonModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; max-width: 800px; width: 90%; max-height: 80%; overflow-y: auto;">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">Contract Comparison</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <h4 style="color: #e67e22;">Reference Contract</h4>
                    <p id="referenceContractName" style="color: #2c3e50;"></p>
                    <p style="color: #6c757d; font-size: 0.9em;">From database</p>
                </div>
                <div>
                    <h4 style="color: #e67e22;">New Contract</h4>
                    <div class="upload-area" onclick="document.getElementById('newContractFile').click()" style="padding: 20px; margin-top: 10px;">
                        <div style="font-size: 1.5em; margin-bottom: 10px;">📎</div>
                        <p>Upload new contract to compare</p>
                        <input type="file" id="newContractFile" accept=".pdf,.docx,.txt" onchange="handleNewContractUpload(this)" style="display: none;">
                    </div>
                    <div class="file-info" id="newContractInfo" style="display: none;"></div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-bottom: 20px;">
                <button onclick="closeComparisonModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; transition: all 0.3s ease;">Cancel</button>
                <button onclick="startContractComparison()" id="startComparisonBtn" style="background: linear-gradient(135deg, #485056 0%, #485056 100%); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 1em; transition: all 0.3s ease; margin: 0;" disabled>Start Comparison</button>
            </div>

            <div class="loading" id="comparisonLoading" style="display: none;">
                <div class="spinner"></div>
                <p>Comparing contracts with AI...</p>
            </div>

            <div class="error" id="comparisonError" style="display: none;"></div>
            
            <div id="comparisonResults" style="display: none;"></div>
        </div>
    </div>
</body>
<script>
// Global authentication state
let currentUser = null;
let isAuthenticated = false;

function addUserAvatarToPage() {
    const existing = document.getElementById('userInfo');
    if (existing) existing.remove();
    
    const user = currentUser || {
        username: 'admin',
        fullName: 'System Administrator',
        role: 'admin',
        email: 'admin@example.com'
    };
    
    const initials = user.fullName ? 
        user.fullName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() :
        user.username.substring(0, 2).toUpperCase();
    
    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3', '#54A0FF', '#5F27CD'];
    const colorIndex = user.username.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0) % colors.length;
    const avatarColor = colors[colorIndex];
    
    const userInfoHTML = `
        <div id="userInfo" style="
            position: fixed;
            top: 20px;
            right: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: #333;
            font-size: 0.9em;
            z-index: 9999;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        ">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div id="userAvatar" style="
                    width: 45px;
                    height: 45px;
                    border-radius: 50%;
                    background: ${avatarColor};
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    font-size: 16px;
                    color: white;
                    border: 2px solid rgba(255, 255, 255, 0.8);
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                    cursor: pointer;
                    transition: all 0.3s ease;
                    position: relative;
                " onclick="toggleUserMenu()" 
                   onmouseover="this.style.transform='scale(1.05)'" 
                   onmouseout="this.style.transform='scale(1)'">
                    ${initials}
                    <div style="
                        position: absolute;
                        bottom: 2px;
                        right: 2px;
                        width: 12px;
                        height: 12px;
                        background: #4CAF50;
                        border: 2px solid white;
                        border-radius: 50%;
                        animation: pulse 2s infinite;
                    "></div>
                </div>
                
                <div style="display: flex; flex-direction: column;">
                    <div style="font-weight: 600; margin-bottom: 2px; color: #333;">
                        ${user.fullName || user.username}
                    </div>
                    <div style="opacity: 0.7; font-size: 0.8em; color: #666; text-transform: capitalize;">
                        ${user.role}
                    </div>
                </div>
            </div>
            
            <div id="userMenu" style="
                position: absolute;
                top: 100%;
                right: 0;
                background: white;
                border-radius: 12px;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
                padding: 8px 0;
                min-width: 220px;
                display: none;
                z-index: 10000;
                border: 1px solid rgba(0, 0, 0, 0.1);
                margin-top: 8px;
            ">
                <div style="padding: 15px 16px; border-bottom: 1px solid #eee; color: #333;">
                    <div style="font-weight: 600; margin-bottom: 4px; font-size: 1em;">${user.fullName || user.username}</div>
                    <div style="font-size: 0.85em; color: #666;">${user.email || user.username}</div>
                </div>
            
                
                ${user.role === 'admin' ? `
                    <button onclick="switchTab('admin-panel'); toggleUserMenu();" style="
                        width: 100%;
                        background: none;
                        border: none;
                        padding: 12px 16px;
                        text-align: left;
                        cursor: pointer;
                        color: #333;
                        font-size: 0.9em;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='none'">
                        Admin Panel
                    </button>
                ` : ''}
                
                <div style="border-top: 1px solid #eee; margin: 8px 0;"></div>
                
                <button onclick="logout()" style="
                    width: 100%;
                    background: none;
                    border: none;
                    padding: 12px 16px;
                    text-align: left;
                    cursor: pointer;
                    color: #dc3545;
                    font-size: 0.9em;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                " onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='none'">
                    Logout
                </button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', userInfoHTML);
    
    if (!document.getElementById('userAvatarStyles')) {
        const styles = document.createElement('style');
        styles.id = 'userAvatarStyles';
        styles.textContent = `
            @keyframes pulse {
                0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
                70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
                100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
            }
            
            @media (max-width: 768px) {
                #userInfo {
                    right: 15px !important;
                    top: 15px !important;
                    padding: 8px 12px !important;
                    gap: 10px !important;
                }
                
                #userInfo > div > div:last-child {
                    display: none !important;
                }
                
                #userMenu {
                    right: -10px !important;
                    min-width: 180px !important;
                }
            }
        `;
        document.head.appendChild(styles);
    }
    
    console.log('✅ User avatar added permanently');
}

function onAuthenticationChanged(isAuthenticated) {
    if (isAuthenticated) {
        // 用户登录后重新初始化聊天历史
        if (chatHistory) {
            chatHistory.loadConversations();
        }
        console.log('✅ Chat history reloaded for authenticated user');
    } else {
        // 用户登出后清空聊天历史
        if (chatHistory) {
            chatHistory.conversations = [];
            chatHistory.currentConversationId = null;
            chatHistory.updateHistoryUI();
        }
        console.log('🔄 Chat history cleared for unauthenticated user');
    }
}

// Check authentication status on page load
async function checkAuthentication() {
    try {
        const response = await fetch('/api/auth/me');
        const data = await response.json();
        
        if (data.loggedIn) {
            currentUser = data.user;
            isAuthenticated = true;
            
            addUserAvatarToPage();
            
            if (currentUser.role === 'admin') {
                showAdminFeatures();
            }
            
            console.log('✅ User authenticated:', data.user.username);
        } else {
            onAuthenticationChanged(false);
            window.location.href = '/login.html';
        }
    } catch (error) {
        console.error('Authentication check failed:', error);
        window.location.href = '/login.html';
    }
}

function generateUserAvatar(fullName, username) {
    if (fullName && fullName.trim()) {
        const names = fullName.trim().split(' ');
        if (names.length >= 2) {
            return (names[0][0] + names[names.length - 1][0]).toUpperCase();
        } else {
            return names[0].substring(0, 2).toUpperCase();
        }
    } else if (username) {
        return username.substring(0, 2).toUpperCase();
    }
    return 'U';
}

function generateAvatarColor(str) {
    const colors = [
        '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57',
        '#FF9FF3', '#54A0FF', '#5F27CD', '#10AC84', '#EE5A24',
        '#3742FA', '#2F3542', '#FF3838', '#FF9500', '#2ED573'
    ];
    
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    return colors[Math.abs(hash) % colors.length];
}

// Update UI for authenticated user
function updateUIForAuthenticatedUser() {
    addUserAvatarToPage();
    
    if (currentUser.role === 'admin') {
        showAdminFeatures();
    }
}

function toggleUserMenu() {
    const menu = document.getElementById('userMenu');
    if (menu) {
        menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }
}

document.addEventListener('click', function(e) {
    const userInfo = document.getElementById('userInfo');
    const userMenu = document.getElementById('userMenu');
    if (userInfo && userMenu && !userInfo.contains(e.target)) {
        userMenu.style.display = 'none';
    }
});

// Show admin features
function showAdminFeatures() {
    // Add admin panel link or features
    const tabNavigation = document.querySelector('.tab-navigation');
    if (tabNavigation && !document.getElementById('adminTab')) {
        const adminTab = document.createElement('button');
        adminTab.id = 'adminTab';
        adminTab.className = 'tab-button';
        adminTab.textContent = 'Admin Panel';
        adminTab.onclick = () => switchTab('admin-panel');
        tabNavigation.appendChild(adminTab);
        
        // Create admin panel content
        createAdminPanel();
    }
}

// Create admin panel
function createAdminPanel() {
    const container = document.querySelector('.container');
    const adminPanel = document.createElement('div');
    adminPanel.id = 'admin-panel';
    adminPanel.className = 'tab-content';
    adminPanel.innerHTML = `
        <div class="section">
            <h2>User Management</h2>
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn" onclick="loadUsers()" style="flex: 1; min-width: 150px; background: #505E74;">Load Users</button>
                <button class="btn" onclick="loadLoginStats()" style="flex: 1; min-width: 150px; background: #505E74;">Login Statistics</button>
                <button class="btn" onclick="exportUserData()" style="flex: 1; min-width: 150px; background: #505E74;">Export Data</button>
            </div>
            <div id="usersTable"></div>
        </div>
        
        <div class="section">
            <h2>Login Statistics</h2>
            <div id="loginStatsContainer" style="display: none;">
                <div id="loginStatsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <!-- Stats cards will be loaded here -->
                </div>
                <div id="topUsersSection">
                    <!-- Top users table will be loaded here -->
                </div>
            </div>
        </div>
    `;
    
    // Insert before closing container div
    container.appendChild(adminPanel);
}

// Load users for admin panel
async function loadUsers() {
    try {
        const response = await fetch('/api/admin/users');
        const data = await response.json();
        
        if (data.success) {
            displayUsers(data.users);
        } else {
            alert('Failed to load users');
        }
    } catch (error) {
        console.error('Error loading users:', error);
        alert('Error loading users');
    }
}

// Display users table
function displayUsers(users) {
    const usersTable = document.getElementById('usersTable');
    usersTable.innerHTML = `
        <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em; color: #6c757d;">
            Total Users: <strong>${users.length}</strong> | 
            Active Users: <strong>${users.filter(u => u.is_active).length}</strong> | 
            Admin Users: <strong>${users.filter(u => u.role === 'admin').length}</strong>
        </div>
        <div style="overflow-x: auto;">
            <table class="contracts-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Full Name</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Login Count</th>
                        <th>Created</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${users.map(user => `
                        <tr>
                            <td style="font-weight: 600;">${user.username}</td>
                            <td>${user.email}</td>
                            <td>${user.full_name || 'N/A'}</td>
                            <td><span style="background: '#F8F9FA'; color: ${user.role === 'admin' ? '#dc3545' : '#28a745'}; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold;">${user.role.toUpperCase()}</span></td>
                            <td><span style="background: '#F8F9FA'; color:  ${user.is_active ? '#28a745' : '#dc3545'}; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold;">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td style="text-align: center;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-weight: bold; color: ${user.login_count > 10 ? '#505E74' : user.login_count > 5 ? '#505E74' : '#505E74'}; font-size: 1.1em;">
                                        ${user.login_count || 0}
                                    </span>
                                    ${user.login_count > 0 ? `
                                        <button onclick="resetLoginCount(${user.id}, '${user.username}')" 
                                                style="background: #6b7280; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 0.7em;" 
                                                title="Reset login count">
                                            Reset
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                            <td>${new Date(user.created_at).toLocaleDateString()}</td>
                            <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() + ' ' + new Date(user.last_login).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Never'}</td>
                            <td>
                                <button onclick="toggleUserStatus(${user.id}, ${!user.is_active})" 
                                        style="background: ${user.is_active ? '#dc3545' : '#28a745'}; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                                    ${user.is_active ? 'Deactivate' : 'Activate'}
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

async function loadLoginStats() {
    try {
        const response = await fetch('/api/admin/login-stats');
        const data = await response.json();
        
        if (data.success) {
            displayLoginStats(data.stats);
            document.getElementById('loginStatsContainer').style.display = 'block';
        } else {
            alert('Failed to load login statistics');
        }
    } catch (error) {
        console.error('Error loading login stats:', error);
        alert('Error loading login statistics');
    }
}

function displayLoginStats(stats) {
    const statsGrid = document.getElementById('loginStatsGrid');
    statsGrid.innerHTML = `
        <div class="stat-item" style="background: #505E74; color: white; padding: 20px; border-radius: 10px; text-align: center;">
            <div style="font-size: 1em; font-weight: bold; margin-bottom: 5px;">${stats.totalLogins}</div>
            <div style="opacity: 0.9;">Total Logins</div>
        </div>
        
        <!-- Active Users -->
        <div class="stat-item" style="background: #505E74; color: white; padding: 20px; border-radius: 10px; text-align: center;">
            <div style="font-size: 1em; font-weight: bold; margin-bottom: 5px;">${stats.activeUsers}</div>
            <div style="opacity: 0.9;">Active Users</div>
        </div>
        
        <!-- Recent Logins -->
        <div class="stat-item" style="background: #505E74; color: white; padding: 20px; border-radius: 10px; text-align: center;">
            <div style="font-size: 1em; font-weight: bold; margin-bottom: 5px;">${stats.recentUsers}</div>
            <div style="opacity: 0.9;">Recent Logins (7 days)</div>
        </div>
    `;
    
    const topUsersSection = document.getElementById('topUsersSection');
    if (stats.topUsers && stats.topUsers.length > 0) {
        topUsersSection.innerHTML = `
            <h3 style="margin: 20px 0 15px 0; color: #374151;">Top Users by Login Count</h3>
            <div style="overflow-x: auto;">
                <table class="contracts-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Username</th>
                            <th>Full Name</th>
                            <th>Login Count</th>
                            <th>Last Login</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${stats.topUsers.map((user, index) => `
                            <tr>
                                <td style="text-align: center; font-weight: bold; color: ${index === 0 ? 'black' : index === 1 ? 'black' : index === 2 ? 'black' : 'black'};">
                                    ${index + 1}${index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : ''}
                                </td>
                                <td style="font-weight: 600;">${user.username}</td>
                                <td>${user.full_name || 'N/A'}</td>
                                <td style="text-align: center; font-weight: bold; color: #059669; font-size: 1.1em;">${user.login_count}</td>
                                <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() + ' ' + new Date(user.last_login).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Never'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else {
        topUsersSection.innerHTML = '<p style="color: #6b7280; font-style: italic;">No login data available.</p>';
    }
}

async function resetLoginCount(userId, username) {
    if (confirm(`Are you sure you want to reset the login count for user "${username}"?`)) {
        try {
            const response = await fetch(`/api/admin/users/${userId}/reset-login-count`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Login count reset successfully');
                loadUsers(); // Refresh the table
                loadLoginStats(); // Refresh stats
            } else {
                alert('Failed to reset login count');
            }
        } catch (error) {
            console.error('Error resetting login count:', error);
            alert('Error resetting login count');
        }
    }
}

async function exportUserData() {
    try {
        const response = await fetch('/api/admin/users');
        const data = await response.json();
        
        if (data.success) {
            const csvContent = generateUserCSV(data.users);
            downloadCSV(csvContent, `user_data_${new Date().toISOString().split('T')[0]}.csv`);
        } else {
            alert('Failed to export user data');
        }
    } catch (error) {
        console.error('Error exporting user data:', error);
        alert('Error exporting user data');
    }
}

function generateUserCSV(users) {
    const headers = ['Username', 'Email', 'Full Name', 'Role', 'Status', 'Login Count', 'Created Date', 'Last Login'];
    const csvRows = [headers.join(',')];
    
    users.forEach(user => {
        const row = [
            `"${user.username}"`,
            `"${user.email}"`,
            `"${user.full_name || 'N/A'}"`,
            `"${user.role}"`,
            `"${user.is_active ? 'Active' : 'Inactive'}"`,
            user.login_count || 0,
            `"${new Date(user.created_at).toLocaleDateString()}"`,
            `"${user.last_login ? new Date(user.last_login).toLocaleDateString() + ' ' + new Date(user.last_login).toLocaleTimeString() : 'Never'}"`
        ];
        csvRows.push(row.join(','));
    });
    
    return csvRows.join('\n');
}

function downloadCSV(csvContent, filename) {
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

// Toggle user status
async function toggleUserStatus(userId, newStatus) {
    try {
        const response = await fetch(`/api/admin/users/${userId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ isActive: newStatus })
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadUsers(); // Refresh the table
        } else {
            alert('Failed to update user status');
        }
    } catch (error) {
        console.error('Error updating user status:', error);
        alert('Error updating user status');
    }
}

function toggleGoogleSearch() {
    const sidebar = document.getElementById('googleSearchSidebar');
    if (sidebar.style.display === 'none' || !sidebar.style.display) {
        sidebar.style.display = 'block';
    } else {
        sidebar.style.display = 'none';
    }
}

function closeGoogleSearch() {
    document.getElementById('googleSearchSidebar').style.display = 'none';
}

function handleGoogleSearchKeyPress(event) {
    if (event.key === 'Enter') {
        performGoogleSearch();
    }
}

async function performGoogleSearch() {
    const query = document.getElementById('googleSearchInput').value.trim();
    if (!query) return;
    
    try {
        const response = await fetch('/api/google-search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query })
        });
        
        const results = await response.json();
        displayGoogleResults(results);
    } catch (error) {
        console.error('Google search error:', error);
    }
}

function displayGoogleResults(results) {
    const resultsDiv = document.getElementById('googleSearchResults');
}

// Logout function
async function logout() {
    if (confirm('Are you sure you want to logout?')) {
        try {
            const response = await fetch('/api/auth/logout', {
                method: 'POST'
            });
            
            if (response.ok) {
                window.location.href = '/login.html';
            } else {
                alert('Logout failed');
            }
        } catch (error) {
            console.error('Logout error:', error);
            // Force logout by redirecting
            window.location.href = '/login.html';
        }
    }
}

// Override existing functions to include authentication checks
const authOriginalAnalyzeContract = window.analyzeContract;
window.analyzeContract = function() {
    if (!isAuthenticated) {
        alert('Please login to analyze contracts');
        window.location.href = '/login.html';
        return;
    }
    return authOriginalAnalyzeContract.apply(this, arguments);
};

const originalSearchContractsAndJira = window.searchContractsAndJira;
window.searchContractsAndJira = function() {
    if (!isAuthenticated) {
        alert('Please login to search contracts');
        window.location.href = '/login.html';
        return;
    }
    return originalSearchContractsAndJira.apply(this, arguments);
};

// Initialize authentication on page load
document.addEventListener('DOMContentLoaded', function() {
    checkAuthentication();
});

// Handle session expiration
window.addEventListener('beforeunload', function() {
    // Optional: You can add session cleanup here
});

// Check authentication every 30 minutes
setInterval(checkAuthentication, 30 * 60 * 1000);
</script>
</html>